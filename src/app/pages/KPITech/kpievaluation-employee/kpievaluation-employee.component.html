<div style="display: flex; flex-direction: column; height: 95vh;">
    <!-- Toolbar -->
    <div class="card-header bg-white p-1 d-flex gap-1 flex-wrap align-items-center" style="flex-shrink: 0;">
        <label class="fs-12 mb-0" style="font-size: 0.75rem !important;">Năm:</label>
        <nz-input-number [(ngModel)]="txtYear" [nzMin]="2020" [nzMax]="9999" [nzStep]="1"
            (ngModelChange)="txtYear_ValueChanged()" style="width: 80px;" nzSize="small" class="fs-12">
        </nz-input-number>

        <label class="fs-12 mb-0" style="font-size: 0.75rem !important;">Tìm kiếm:</label>
        <input nz-input nzSize="small" [(ngModel)]="txtKeywords" placeholder="Nhập từ khóa"
            (keyup.enter)="btnSearch_Click()" style="width: 200px; font-size: 0.75rem !important;" class="fs-12">

        <button nz-button nzType="primary" nzSize="small" (click)="btnSearch_Click()" class="fs-12"
            style="font-size: 0.75rem !important;">
            <i nz-icon nzType="search"></i>
            Tìm kiếm
        </button>

        <div style="flex: 1;"></div>

        <label class="mb-0 fw-bold text-primary fs-12" style="font-size: 0.85rem !important;">{{ sessionName }}</label>

        <nz-divider nzType="vertical" style="height: 24px;"></nz-divider>

        <button nz-button nzType="default" nzSize="small" (click)="btnEmployeeApproved_Click()" class="fs-12"
            [disabled]="isTBPView">
            <i nz-icon nzType="form"></i>
            Đánh giá KPI
        </button>

        <button nz-button nzType="primary" nzSize="small" (click)="btnSuccessKPI_Click()" class="fs-12"
            [disabled]="isTBPView">
            <i nz-icon nzType="check-circle"></i>
            Hoàn thành đánh giá
        </button>

        <!-- Button to toggle left panel -->
        <button nz-button nzType="text" nzSize="small" *ngIf="sizeLeftPanel === '0' && !isTBPView"
            (click)="openLeftPanel()" nz-tooltip nzTooltipTitle="Mở panel bên trái" class="fs-12">
            <i nz-icon nzType="menu-unfold"></i>
        </button>
    </div>

    <!-- Main Content with Splitter -->
    <div class="modal-body p-0" style="overflow: hidden; min-height: 0; flex: 1;">
        <nz-splitter nzLayout="horizontal" style="height: 100%; min-height: 0;">
            <!-- Left Panel: Session & Exam Grids -->
            <nz-splitter-panel [nzSize]="sizeLeftPanel === '' ? undefined : sizeLeftPanel" nzDefaultSize="25%"
                nzMin="10%" nzMax="50%" [nzCollapsible]="true" nzResizable="true">
                <nz-splitter nzLayout="vertical" style="height: 100%">
                    <!-- Session Panel -->
                    <nz-splitter-panel nzDefaultSize="55%" nzMin="10%" nzMax="90%">
                        <div class="card h-100 border-0 rounded-0 d-flex flex-column">
                            <div class="card-header bg-white p-1 d-flex justify-content-between align-items-center"
                                style="font-weight: bold !important; background-color: #efebebe7 !important;">
                                <p class="m-0 fs-12">THÔNG TIN KỲ ĐÁNH GIÁ</p>
                                <button nz-button nzType="text" nzSize="small" class="btn-close-panel"
                                    style="color: red;" (click)="closeLeftPanel()" *ngIf="sizeLeftPanel !== '0'">
                                    <i nz-icon nzType="close"></i>
                                </button>
                            </div>
                            <div class="card-header bg-white p-1">
                                <div class="d-flex align-items-center gap-1">
                                    <label class="mb-0 fs-12" style="font-size: 0.75rem !important;">Chọn Team:</label>
                                    <nz-select [(ngModel)]="cboChoicePosition" nzShowSearch nzAllowClear
                                        nzPlaceHolder="Chọn team" style="flex: 1; min-width: 100px;" nzSize="small"
                                        class="fs-12" [nzDisabled]="isChoicePositionReadonly">
                                        @for (item of positionData; track item.ID) {
                                        <nz-option [nzValue]="item.ID" [nzLabel]="item.PositionName"></nz-option>
                                        }
                                    </nz-select>
                                    <button nz-button nzType="primary" nzSize="small" class="fs-12"
                                        (click)="btnChoicePosition_Click()" [disabled]="isChoicePositionReadonly">
                                        Xác nhận
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0 flex-grow-1 overflow-hidden grid-session-container"
                                style="min-height: 0;">
                                <angular-slickgrid gridId="grid-session" [columns]="sessionColumns"
                                    [options]="sessionGridOptions" [dataset]="dataSession"
                                    (onAngularGridCreated)="onSessionGridReady($event)"
                                    (onSelectedRowsChanged)="onSessionRowSelectionChanged($event)">
                                </angular-slickgrid>
                            </div>
                        </div>
                    </nz-splitter-panel>

                    <!-- Exam Panel -->
                    <nz-splitter-panel nzDefaultSize="45%" nzMin="10%" nzMax="90%">
                        <div class="card h-100 border-0 rounded-0 d-flex flex-column">
                            <div class="card-header bg-white p-1"
                                style="font-weight: bold !important; background-color: #efebebe7 !important;">
                                <p class="m-0">DANH SÁCH BÀI ĐÁNH GIÁ</p>
                            </div>
                            <div class="card-body p-0 flex-grow-1 overflow-hidden grid-exam-container"
                                style="min-height: 0;">
                                <angular-slickgrid gridId="grid-exam" [columns]="examColumns"
                                    [options]="examGridOptions" [dataset]="dataExam"
                                    (onAngularGridCreated)="onExamGridReady($event)"
                                    (onSelectedRowsChanged)="onExamRowSelectionChanged($event)">
                                </angular-slickgrid>
                            </div>
                        </div>
                    </nz-splitter-panel>
                </nz-splitter>
            </nz-splitter-panel>

            <!-- Right Panel: Tabs with Evaluation Grids -->
            <nz-splitter-panel [nzSize]="sizeRightPanel" nzDefaultSize="75%" nzMin="50%" nzMax="90%" nzResizable="true">
                <div class="card h-100 border-0 rounded-0 d-flex flex-column">
                    <div class="card-body p-2 flex-grow-1" style="min-height: 0; overflow: hidden;">
                        <nz-tabset [(nzSelectedIndex)]="selectedTabIndex" (nzSelectedIndexChange)="onTabChange($event)"
                            nzType="card" style="height: 88vh !important;">
                            <!-- Tab 1: Kỹ năng (treeData) -->
                            <nz-tab nzTitle="ĐÁNH GIÁ KỸ NĂNG">
                                <div class="grid-evaluation-container" style="height: 100%; position: relative;">
                                    <angular-slickgrid *ngIf="gridsInitialized && logicalTabIndex === 0"
                                        gridId="grid-evaluation" [columns]="evaluationColumns"
                                        [options]="evaluationGridOptions" [dataset]="dataEvaluation"
                                        (onAngularGridCreated)="onEvaluationGridReady($event)">
                                    </angular-slickgrid>
                                </div>
                            </nz-tab>

                            <!-- Tab 2: Chung (treeList2 / xtraTabPage4) -->
                            <nz-tab nzTitle="ĐÁNH GIÁ CHUNG" *ngIf="showTabGeneral">
                                <div class="grid-evaluation4-container" style="height: 100%; position: relative;">
                                    <angular-slickgrid *ngIf="gridsInitialized && logicalTabIndex === 1"
                                        gridId="grid-evaluation4" [columns]="evaluation4Columns"
                                        [options]="evaluation4GridOptions" [dataset]="dataEvaluation4"
                                        (onAngularGridCreated)="onEvaluation4GridReady($event)">
                                    </angular-slickgrid>
                                </div>
                            </nz-tab>

                            <!-- Tab 3: Chuyên môn (treeList1 / xtraTabPage2) -->
                            <nz-tab nzTitle="ĐÁNH GIÁ CHUYÊN MÔN" *ngIf="showTabChuyenMon">
                                <div class="grid-evaluation2-container" style="height: 100%; position: relative;">
                                    <angular-slickgrid *ngIf="gridsInitialized && logicalTabIndex === 2"
                                        gridId="grid-evaluation2" [columns]="evaluation2Columns"
                                        [options]="evaluation2GridOptions" [dataset]="dataEvaluation2"
                                        (onAngularGridCreated)="onEvaluation2GridReady($event)">
                                    </angular-slickgrid>
                                </div>
                            </nz-tab>

                            <!-- Tab 4: Tổng hợp (grdMaster / xtraTabPage3) -->
                            <nz-tab nzTitle="TỔNG HỢP ĐÁNH GIÁ">
                                <div class="grid-master-container" style="height: 100%; position: relative;">
                                    <angular-slickgrid *ngIf="gridsInitialized && logicalTabIndex === 3"
                                        gridId="grid-master" [columns]="masterColumns" [options]="masterGridOptions"
                                        [dataset]="dataMaster" (onAngularGridCreated)="onMasterGridReady($event)">
                                    </angular-slickgrid>
                                </div>
                            </nz-tab>

                            <!-- Tab 5: KPI Rule (tlKPIRule) -->
                            <nz-tab nzTitle="KPI RULE" *ngIf="showTabRule">
                                <div class="grid-rule-container" style="height: 100%; position: relative;">
                                    <angular-slickgrid *ngIf="gridsInitialized && logicalTabIndex === 4"
                                        gridId="grid-rule" [columns]="ruleColumns" [options]="ruleGridOptions"
                                        [dataset]="dataRule" (onAngularGridCreated)="onRuleGridReady($event)">
                                    </angular-slickgrid>
                                </div>
                            </nz-tab>

                            <!-- Tab 6: Team Rule (grdTeam) -->
                            <nz-tab nzTitle="TEAM RULE" *ngIf="showTabTeam">
                                <div class="grid-team-container" style="height: 100%; position: relative;">
                                    <angular-slickgrid *ngIf="gridsInitialized && logicalTabIndex === 5"
                                        gridId="grid-team" [columns]="teamColumns" [options]="teamGridOptions"
                                        [dataset]="dataTeam" (onAngularGridCreated)="onTeamGridReady($event)">
                                    </angular-slickgrid>
                                </div>
                            </nz-tab>
                        </nz-tabset>
                    </div>
                </div>
            </nz-splitter-panel>
        </nz-splitter>
    </div>
    <!-- Lì xì rơi Easter Egg -->
    <div *ngIf="showLixiRain" class="lixi-container">
        *ngFor="let lixi of lixis" class="lixi" [style.left.%]="lixi.left"
        [style.animation-duration.s]="lixi.animationDuration" [style.animation-delay.s]="lixi.delay"
        le.--rotation.deg]="lixi.rotation">
        {{ lixi.icon }}
        v>
    </div>