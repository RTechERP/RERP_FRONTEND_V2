<ng-container class="w-100">
    <div class="card border-0 rounded-0 h-100">
        <div class="card-header bg-white p-1" style="overflow-x: auto;">
            <div class="d-flex gap-1">
                <button nz-button nzType="default" nzSize="small"
                    (click)="ToggleSearchPanelNew($event); $event.stopPropagation()"
                    (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()"
                    (touchend)="$event.stopPropagation()" class="sticky-toggle-btn"
                    [attr.aria-label]="showSearchBar ? 'Ẩn tìm kiếm' : 'Hiện tìm kiếm'"
                    [attr.aria-expanded]="showSearchBar" type="button">
                    <nz-icon [nzType]="showSearchBar ? 'up' : 'down'" />
                </button>

                <button class="fs-12 btn-add" nz-button nzType="default" nzSize="small" (click)="openAddModal()">
                    <img src="assets/icon/action_add_item_16.png" alt="Thêm" /> Thêm
                </button>
                <button class="fs-12 btn-edit" nz-button nzType="default" nzSize="small" (click)="openEditModal()">
                    <img src="assets/icon/action_edit_item_16.png" alt="Sửa" /> Sửa
                </button>
                <button class="fs-12 btn-delete" nz-button nzType="default" nzSize="small" (click)="openDeleteModal()">
                    <img src="assets/icon/action_delete_item_16.png" alt="Xóa" /> Xóa
                </button>
                <button class="fs-12" nz-button nzType="default" nzSize="small" (click)="isApproveTBP(true)" *hasPermission="'N1'">
                    <img src="assets/icon/action_approved_16.png" alt="Duyệt" /> TBP Duyệt
                </button>
                <button class="fs-12" nz-button nzType="default" nzSize="small" (click)="isApproveTBP(false)" *hasPermission="'N1'">
                    <img src="assets/icon/action_unapproved_16.png" alt="Hủy duyệt" /> TBP hủy duyệt
                </button>
                <button class="fs-12" nz-button nzType="default" nzSize="small" (click)="isApproveHR()" *hasPermission="'N2,N1'">
                    <img src="assets/icon/action_approved_16.png" alt="Duyệt" /> HR Duyệt
                </button>
                <button class="fs-12" nz-button nzType="default" nzSize="small" (click)="isDisapproveHR()" *hasPermission="'N2,N1'">
                    <img src="assets/icon/action_unapproved_16.png" alt="Hủy duyệt" /> HR hủy duyệt
                </button>
                <button class="fs-12" nz-button nzType="default" nzSize="small" (click)="exportToExcel()" *hasPermission="'N2,N1'">
                    <img src="assets/icon/action_export_excel_16.png" alt="Xuất excel" /> Xuất excel
                </button>
            </div>
        </div>

        <!-- Backdrop overlay cho mobile -->
        <div class="filter-backdrop" *ngIf="shouldShowSearchBar" (click)="ToggleSearchPanelNew()" [class.mobile-only]="true"></div>

        <!-- Filter bar -->
        <div class="filter-bar bg-light border-bottom p-2" *ngIf="shouldShowSearchBar" [class.mobile-modal]="true">
            <form nz-form [formGroup]="searchForm" class="mobile-filter-form">
                <nz-row [nzGutter]="[8, 8]" nzAlign="bottom">
                    <!-- Tháng -->
                    <nz-col [nzXs]="12" [nzSm]="6" [nzMd]="4" [nzLg]="3" [nzXl]="3">
                        <nz-form-item class="mb-0">
                            <nz-form-label class="fs-12" >Tháng</nz-form-label>
                            <nz-form-control>
                                <nz-input-number formControlName="month" nzMin="1" nzMax="12" nzSize="small" class="w-100"></nz-input-number>
                            </nz-form-control>
                        </nz-form-item>
                    </nz-col>

                    <!-- Năm -->
                    <nz-col [nzXs]="12" [nzSm]="6" [nzMd]="4" [nzLg]="3" [nzXl]="3">
                        <nz-form-item class="mb-0">
                            <nz-form-label class="fs-12" >Năm</nz-form-label>
                            <nz-form-control>
                                <nz-input-number formControlName="year" nzMin="1" nzMax="3000" nzSize="small" class="w-100"></nz-input-number>
                            </nz-form-control>
                        </nz-form-item>
                    </nz-col>

                    <!-- Phòng ban -->
                    <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="4" [nzXl]="4">
                        <nz-form-item class="mb-0">
                            <nz-form-label class="fs-12" >Phòng ban</nz-form-label>
                            <nz-form-control>
                                <nz-select formControlName="departmentId" nzShowSearch nzAllowClear nzSize="small" nzPlaceHolder="Chọn phòng ban" class="w-100">
                                    <nz-option *ngFor="let dept of departmentList" [nzValue]="dept.ID" [nzLabel]="dept.Name"></nz-option>
                                </nz-select>
                            </nz-form-control>
                        </nz-form-item>
                    </nz-col>

                    <!-- Trạng thái TBP -->
                    <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="4" [nzXl]="4">
                        <nz-form-item class="mb-0">
                            <nz-form-label class="fs-12" >Trạng thái TBP</nz-form-label>
                            <nz-form-control>
                                <nz-select formControlName="status" nzShowSearch nzSize="small" nzPlaceHolder="Chọn trạng thái" class="w-100">
                                    <nz-option nzValue="0" nzLabel="Chờ duyệt"></nz-option>
                                    <nz-option nzValue="1" nzLabel="Đã duyệt"></nz-option>
                                    <nz-option nzValue="2" nzLabel="Không đồng ý duyệt"></nz-option>
                                </nz-select>
                            </nz-form-control>
                        </nz-form-item>
                    </nz-col>

                    <!-- Từ khóa và nút tìm kiếm -->
                    <nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="6" [nzXl]="4">
                        <nz-form-item class="mb-0">
                            <nz-form-label class="fs-12" >Từ khóa</nz-form-label>
                            <nz-form-control>
                                <div class="d-flex gap-1">
                                    <input nz-input placeholder="Nhập từ khóa..." nzSize="small" formControlName="keyWord" class="flex-grow-1" (keyup.enter)="loadEarlyLate()" />
                                    <button nz-button nzType="primary" style="width: 40px;" nzSize="small" (click)="loadEarlyLate()">
                                        <nz-icon nzType="search" />
                                    </button>
                                </div>
                            </nz-form-control>
                        </nz-form-item>
                    </nz-col>
                </nz-row>
            </form>
        </div>

        <!-- Content với bảng -->
        <div class="card-body p-0 position-relative fs-12" [class.with-search-bar]="shouldShowSearchBar" [class.without-search-bar]="!shouldShowSearchBar">
            <div *ngIf="isLoading">
                <nz-spin [nzSpinning]="isLoading" nzSimple [style]="{
                    position: 'absolute',
                    top: '0',
                    left: '0',
                    width: '100%',
                    height: '100%',
                    background: 'rgba(255,255,255,0.4)',
                    zIndex: '999',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                }"></nz-spin>
            </div>
            <div id="tb_early_late"></div>
        </div>
    </div>
</ng-container>

<div
  class="modal fade"
  id="addEarlyLateModal"
  tabindex="-1"
  aria-labelledby="addEarlyLateModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered fs-12">
    <div class="modal-content">
      <div class="modal-header bg-primary p-1">
        <h6
          class="modal-title text-uppercase text-white"
          id="addEarlyLateModalLabel"
        >
          CHI TIẾT ĐI MUỘN - VỀ SỚM
        </h6>
        <button
          type="button"
          class="btn-close me-2"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form nz-form [formGroup]="earlyLateForm">
          <nz-form-item class="mb-2">
            <nz-form-label [nzSpan]="24" class="fs-12 p-0"
              >Họ và tên<span class="text-danger ps-1">*</span></nz-form-label
            >
            <nz-form-control
              [nzSpan]="24"
              nzErrorTip="Vui lòng chọn tên nhân viên"
            >
              <nz-select
                class="w-100"
                nzShowSearch
                nzAllowClear
                nzSize="default"
                formControlName="EmployeeID"
                nzPlaceHolder="Chọn họ tên nhân viên"
              >
                @for (item of employeeList; track $index) {
                <nz-option
                  nzCustomContent="true"
                  [nzLabel]="item.FullName"
                  [nzValue]="item.ID"
                  >{{ item.Code + " - " + item.FullName }}</nz-option
                >
                }
              </nz-select>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item class="mb-2">
            <nz-form-label [nzSpan]="24" class="fs-12 p-0"
              >Người duyệt<span class="text-danger ps-1">*</span></nz-form-label
            >
            <nz-form-control
              [nzSpan]="24"
              nzErrorTip="Vui lòng chọn người duyệt"
            >
              <nz-select
                formControlName="ApprovedTP"
                nzPlaceHolder="Chọn người duyệt"
                nzShowSearch
                nzAllowClear
                [nzFilterOption]="filterOption"
                class="fs-12 w-100"
              >
                <nz-option-group
                  *ngFor="let group of approvers"
                  [nzLabel]="group.department"
                >
                  <nz-option
                    *ngFor="let approver of group.list"
                    [nzValue]="approver.ID"
                    [nzLabel]="approver.Code + ' - ' + approver.FullName"
                  >
                  </nz-option>
                </nz-option-group>
              </nz-select>
            </nz-form-control>
          </nz-form-item>

          <nz-row [nzGutter]="24" class="pb-1">
            <nz-col [nzSpan]="12">
              <nz-form-label class="p-0" class="fs-12 p-0">Ngày</nz-form-label>
            </nz-col>
            <nz-col [nzSpan]="12">
              <nz-form-label class="p-0" class="fs-12 p-0">Loại</nz-form-label>
            </nz-col>
          </nz-row>
          <nz-row [nzGutter]="24">
            <nz-col [nzSpan]="12">
              <nz-date-picker
                formControlName="DateRegister"
                nzPlaceHolder="Chọn ngày đăng ký"
                nzAllowClear="false"
                nzFormat="dd/MM/yyyy"
                [nzSize]="'default'"
                [nzDisabledDate]="disabledDate"
                style="width: 100%"
              ></nz-date-picker>
            </nz-col>
            <nz-col [nzSpan]="12">
              <nz-select
                formControlName="Type"
                style="width: 100%"
                nzPlaceHolder="Chọn thời gian"
              >
                <nz-option
                  [nzValue]="1"
                  nzLabel="Đi muộn việc cá nhân"
                ></nz-option>
                <nz-option
                  [nzValue]="2"
                  nzLabel="Về sớm việc cá nhân"
                ></nz-option>
                <nz-option
                  [nzValue]="3"
                  nzLabel="Về sớm việc công ty"
                ></nz-option>
                <nz-option
                  [nzValue]="4"
                  nzLabel="Đi muộn việc công ty"
                ></nz-option>
              </nz-select>
            </nz-col>
          </nz-row>

          <nz-row [nzGutter]="24" class="pb-1">
            <nz-col [nzSpan]="12">
              <nz-form-label class="p-0" class="fs-12 p-0">Từ</nz-form-label>
            </nz-col>
            <nz-col [nzSpan]="12">
              <nz-form-label class="p-0" class="fs-12 p-0">Đến</nz-form-label>
            </nz-col>
          </nz-row>
          <nz-row [nzGutter]="24">
            <nz-col [nzSpan]="12">
              <nz-time-picker
                formControlName="DateStart"
                nzFormat="HH:mm"
                nzAllowEmpty="false"
                style="width: 100%"
              ></nz-time-picker>
            </nz-col>
            <nz-col [nzSpan]="12">
              <nz-time-picker
                formControlName="DateEnd"
                nzFormat="HH:mm"
                nzAllowEmpty="false"
                style="width: 100%"
              ></nz-time-picker>
            </nz-col>
          </nz-row>

          <nz-form-item class="mb-2">
            <nz-form-label [nzSpan]="24" class="fs-12 p-0"
              >Lý do<span class="text-danger ps-1">*</span></nz-form-label
            >
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập lý do">
              <textarea rows="4" nz-input formControlName="Reason"></textarea>
            </nz-form-control>
          </nz-form-item>

          <ng-container *hasPermission="'N2,N1'">
              <nz-form-item class="mb-2">
            <nz-form-label [nzSpan]="24" class="fs-12 p-0"
              >Lý do sửa<span class="text-danger ps-1">*</span></nz-form-label
            >
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập lý do sửa">
              <textarea
                rows="4"
                nz-input
                formControlName="ReasonHREdit"
              ></textarea>
            </nz-form-control>
          </nz-form-item>
          </ng-container>
        
        </form>
      </div>
      <div class="modal-footer py-0">
        <button
          type="button"
          class="btn btn-outline-danger fs-12"
          (click)="closeModal()"
          style="border: 1px solid; border-radius: 0"
        >
          Đóng
        </button>
        <button
          type="button"
          class="btn btn-primary fs-12"
          (click)="onSubmit()"
          style="border-radius: 0"
        >
          Lưu
        </button>
      </div>
    </div>
  </div>
</div>

<ng-template #reasonTpl>
  <textarea
    [(ngModel)]="reasonText"
    nz-input
    rows="3"
    placeholder="Nhập lý do hủy duyệt..."
    style="width: 100%"
  >
  </textarea>
</ng-template>
