<div class="modal-header bg-primary text-uppercase py-2 flex-shrink-0">
  <h6 class="modal-title text-white">Chi tiết phiếu yêu cầu công việc</h6>
  <button type="button" class="btn-close" (click)="closeModal()" aria-label="Close"></button>
</div>
<div class="modal-body p-2 flex-grow-1">
  <form nz-form [formGroup]="formGroup" class="mt-2 mb-2">
    <!-- Dòng 1: 4 ô -->
    <nz-row [nzGutter]="[8, 8]">
      <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="7">
        <nz-form-item class="mb-0">
          <nz-form-label class="fs-12 required-label p-0" [nzSpan]="24">
            Chọn nhân viên<span class="text-danger ps-1 me-1"> (*)</span>
          </nz-form-label>
          <nz-form-control [nzSpan]="24" [nzErrorTip]="
              formGroup.get('EmployeeID')?.hasError('required') &&
              (formGroup.get('EmployeeID')?.dirty ||
                formGroup.get('EmployeeID')?.touched)
                ? 'Vui lòng chọn nhân viên yêu cầu!'
                : formGroup.get('EmployeeID')?.hasError('maxlength')
                ? 'Tên loại tối đa 100 ký tự!'
                : undefined
            ">
            <nz-select formControlName="EmployeeID" nzPlaceHolder="Chọn nhân viên" style="width: 100%" name="EmployeeID"
              nzShowSearch [nzFilterOption]="filterOption" nzAllowClear (ngModelChange)="onSelectEmployee($event)">
              <nz-option-group *ngFor="let group of cbbEmployeeGroup" [nzLabel]="group.department">
                <nz-option *ngFor="let emp of group.employees" [nzLabel]="emp.Code + ' - ' + emp.FullName"
                  [nzValue]="emp.ID"></nz-option>
              </nz-option-group>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </nz-col>
      <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="7">
        <nz-form-item class="mb-0">
          <nz-form-label class="fs-12 p-0" [nzSpan]="24">Bộ phận yêu cầu</nz-form-label>
          <nz-form-control [nzSpan]="24" [nzErrorTip]="
              formGroup.get('EmployeeDepartment')?.hasError('required') &&
              (formGroup.get('EmployeeDepartment')?.dirty ||
                formGroup.get('EmployeeDepartment')?.touched)
                ? 'Vui lòng chọn phòng ban!'
                : undefined
            ">
            <nz-select formControlName="EmployeeDepartment" [nzPlaceHolder]="'Chọn phòng ban'" style="width: 100%"
              name="EmployeeDepartment" [nzDisabled]="true">
              <nz-option *ngFor="let item of dataDepartment" [nzLabel]="item.Name" [nzValue]="item.ID"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </nz-col>
      <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="5">
        <nz-form-item class="mb-0">
          <nz-form-label class="fs-12 required-label p-0" [nzSpan]="24">Ngày yêu cầu<span class="text-danger ps-1 me-1">
              (*)</span>
          </nz-form-label>
          <nz-form-control [nzSpan]="24" [nzErrorTip]="
              formGroup.get('DateRequest')?.invalid &&
              (formGroup.get('DateRequest')?.dirty ||
                formGroup.get('DateRequest')?.touched)
                ? 'Vui lòng chọn ngày yêu cầu!'
                : undefined
            ">
            <input nz-input type="date" name="DateRequest" formControlName="DateRequest" />
          </nz-form-control>
        </nz-form-item>
      </nz-col>
      <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="5">
        <nz-form-item class="mb-0">
          <nz-form-label class="fs-12 required-label p-0" [nzSpan]="24">Thời gian hoàn thành<span
              class="text-danger ps-1 me-1"> (*)</span>
          </nz-form-label>
          <nz-form-control [nzSpan]="24" [nzErrorTip]="
              formGroup.get('DeadlineRequest')?.invalid &&
              (formGroup.get('DeadlineRequest')?.dirty ||
                formGroup.get('DeadlineRequest')?.touched)
                ? 'Vui lòng chọn thời gian hoàn thành!'
                : undefined
            ">
            <input nz-input type="date" name="DeadlineRequest" formControlName="DeadlineRequest" />
          </nz-form-control>
        </nz-form-item>
      </nz-col>
    </nz-row>
    <nz-row [nzGutter]="[8, 8]">
      <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="7">
        <nz-form-item class="mb-0">
          <nz-form-label class="fs-12 p-0" [nzSpan]="24">
            Trưởng bộ phận duyệt<span class="text-danger ps-1 me-1"> (*)</span>
          </nz-form-label>
          <nz-form-control
            [nzSpan]="24"
            [nzErrorTip]="
              formGroup.get('ApprovedTBPID')?.hasError('required') &&
              (formGroup.get('ApprovedTBPID')?.dirty || formGroup.get('ApprovedTBPID')?.touched)
                ? 'Vui lòng chọn người duyệt'
                : undefined
            "
          >
            <nz-select
              formControlName="ApprovedTBPID"
              nzPlaceHolder="Chọn người duyệt"
              nzShowSearch
              nzAllowClear
              [nzFilterOption]="filterOption"
              class="fs-12 w-100"
            >
              <nz-option-group *ngFor="let group of approverGroups" [nzLabel]="group.department">
                <nz-option
                  *ngFor="let approver of group.list"
                  [nzValue]="approver.ID"
                  [nzLabel]="approver.Code + ' - ' + approver.FullName"
                ></nz-option>
              </nz-option-group>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </nz-col>
      <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="7">
        <nz-form-item class="mb-0">
          <nz-form-label class="fs-12 p-0" [nzSpan]="24">Bộ phận được yêu cầu<span class="text-danger ps-1 me-1">
              (*)</span></nz-form-label>
          <nz-form-control [nzSpan]="24" [nzErrorTip]="
              formGroup.get('RequiredDepartment')?.hasError('required') &&
              (formGroup.get('RequiredDepartment')?.dirty ||
                formGroup.get('RequiredDepartment')?.touched)
                ? 'Vui lòng chọn bộ phận được yêu cầu!'
                : undefined
            ">
            <nz-select formControlName="RequiredDepartment" [nzPlaceHolder]="'Chọn phòng ban'" style="width: 100%"
              name="RequiredDepartment" required>
              <nz-option *ngFor="let item of dataDepartment" [nzLabel]="item.Name" [nzValue]="item.ID"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </nz-col>
      <nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="10">
        <nz-form-item class="mb-0">
          <nz-form-label class="fs-12 p-0" [nzSpan]="24">Bộ phận phối hợp</nz-form-label>
          <nz-form-control [nzSpan]="24" [nzErrorTip]="
              formGroup.get('CoordinationDepartment')?.hasError('required') &&
              (formGroup.get('CoordinationDepartment')?.dirty ||
                formGroup.get('CoordinationDepartment')?.touched)
                ? 'Vui lòng chọn phòng ban!'
                : undefined
            ">
            <nz-select formControlName="CoordinationDepartment" [nzPlaceHolder]="'Chọn phòng ban'" style="width: 100%"
              name="CoordinationDepartment">
              <nz-option *ngFor="let item of dataDepartment" [nzLabel]="item.Name" [nzValue]="item.ID"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </nz-col>
    </nz-row>
  </form>

  <nz-splitter style="height: 59vh !important">
    <nz-splitter-panel nzSize="70%">
      <div class="card-body p-0" style="height: 100%; overflow: auto;">
        <table class="job-requirement-detail-table">
          <thead>
            <tr>
              <th style="width: 50px; text-align: center;">STT</th>
              <th style="width: 180px;">Đề mục</th>
              <th style="width: 200px;">Diễn giải</th>
              <th style="width: 200px;">Mục tiêu cần đạt</th>
              <th>Ghi chú</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of jobRequirementDetailData; let i = index">
              <td style="text-align: center;">{{ item.STT }}</td>
              <td>{{ item.Category }}</td>
              <td>
                <!-- Nếu là "Thời gian hoàn thành đề nghị" thì chỉ hiển thị, không cho edit -->
                <span *ngIf="item.Category === 'Thời gian hoàn thành đề nghị'">{{ item.Description }}</span>
                <!-- Nếu là "Số lượng" thì dùng input chỉ nhập số -->
                <input *ngIf="item.Category === 'Số lượng'" type="text" [(ngModel)]="item.Description"
                  class="form-control form-control-sm text-end" (keypress)="onlyNumberKey($event)"
                  (paste)="onPasteNumber($event)">
                <!-- Các trường khác dùng textarea -->
                <textarea *ngIf="item.Category !== 'Thời gian hoàn thành đề nghị' && item.Category !== 'Số lượng'"
                  [(ngModel)]="item.Description" class="form-control form-control-sm" rows="2"></textarea>
              </td>
              <td>
                <textarea [(ngModel)]="item.Target" class="form-control form-control-sm" rows="2"></textarea>
              </td>
              <td>
                <textarea [(ngModel)]="item.Note" class="form-control form-control-sm" rows="2"></textarea>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </nz-splitter-panel>
    <nz-splitter-panel>
      <div class="card-body p-0" style="height: 100%; display: flex; flex-direction: column;">
        <div class="card-header bg-white p-1" style="flex-shrink: 0;">
          <div class="file-upload-section mb-2">
            <nz-upload [(nzFileList)]="fileList" [nzBeforeUpload]="beforeUpload" [nzMultiple]="true"
              [nzShowUploadList]="false">
              <button nz-button nzSize="small">
                <i nz-icon nzType="upload"></i>
                Thêm file đính kèm
              </button>
            </nz-upload>
          </div>
        </div>
        <div style="flex: 1; min-height: 0; overflow: auto;">
          <table class="job-requirement-file-table">
            <thead>
              <tr>
                <th style="width: 50px; text-align: center;"></th>
                <th>Tên file</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let file of getActiveFiles(); let i = index">
                <td style="text-align: center;">
                  <i class="fas fa-trash text-danger cursor-pointer" (click)="deleteFileByRecord(file)"
                    title="Xóa file"></i>
                </td>
                <td>{{ file.FileNameOrigin || file.name }}</td>
              </tr>
              <tr *ngIf="getActiveFiles().length === 0">
                <td colspan="2" style="text-align: center; padding: 20px;">
                  Chưa có file đính kèm
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </nz-splitter-panel>
  </nz-splitter>
</div>

<div class="modal-footer flex-shrink-0">
  <button class="fs-12 btn" nz-button nzDanger (click)="closeModal()">
    Đóng
  </button>
  <button class="fs-12 btn" nz-button nzType="primary" (click)="saveData()">
    Lưu
  </button>
</div>