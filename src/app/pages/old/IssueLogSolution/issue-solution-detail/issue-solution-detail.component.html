<!-- handover-minutes.component.html -->
<div class="modal-header bg-primary text-uppercase py-2">
    <h6 class="modal-title text-white">CHI TIẾT BIỂU GHI NHẬN LỖI & PHƯƠNG ÁN KHẮC PHỤC</h6>
    <button type="button" class="btn-close" (click)="closeModal()" aria-label="Close"></button>
</div>

<div class="modal-body">
    <!-- Nội dung tab hiện tại -->
    <div class="tab-content">
        <form [formGroup]="form">
            <div class="row g-1 mb-2">
                <!-- Column 1: Customer Info -->
                <div class="col-md-6">
                    <div class="row g-1">
                        <div class="col-md-6 mt-1">
                            <label class="mb-0 fs-12">Loại biểu ghi <span class="text-danger ps-1">(*)</span></label> 
                            <nz-select nzShowSearch nzPlaceHolder="Chọn loại biểu ghi" nzAllowClear
                                nzSize="default" class="w-100" formControlName="issueSolutionType">
                                <nz-option *ngFor="let item of issueSolutionTypes" [nzValue]="item.value"
                                    [nzLabel]="item.name"></nz-option>
                            </nz-select>
                            <div *ngIf="form.get('issueSolutionType')?.invalid && form.get('issueSolutionType')?.touched" class="text-danger fs-12 mt-1">
                                <div *ngIf="form.get('issueSolutionType')?.errors?.['required']">Loại biểu ghi là bắt buộc</div>
                            </div>
                        </div>
                        <div class="col-md-6 mt-1">
                            <label class="mb-0 fs-12">Ngày ghi nhận <span class="text-danger ps-1">(*)</span></label>
                            <nz-date-picker class="w-100" nzFormat="dd/MM/yyyy" nzAllowClear="false"
                                formControlName="dateIssue"></nz-date-picker>
                            <div *ngIf="form.get('dateIssue')?.invalid && form.get('dateIssue')?.touched" class="text-danger fs-12 mt-1">
                                <div *ngIf="form.get('dateIssue')?.errors?.['required']">Ngày ghi nhận là bắt buộc</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="mb-0 fs-12">Phòng ghi nhận <span class="text-danger ps-1">(*)</span></label>
                            <nz-select nzShowSearch nzPlaceHolder="Chọn phòng ghi nhận" nzAllowClear
                                nzSize="default" class="w-100" formControlName="departmentId">
                                <nz-option *ngFor="let department of departments" [nzValue]="department.ID"
                                    [nzLabel]="department.Name"></nz-option>
                            </nz-select>
                            <div *ngIf="form.get('departmentId')?.invalid && form.get('departmentId')?.touched" class="text-danger fs-12 mt-1">
                                <div *ngIf="form.get('departmentId')?.errors?.['required']">Phòng ghi nhận là bắt buộc</div>
                            </div>
                        </div>
                        <div class="col-md-6 mt-1">
                            <label class="mb-0 fs-12">Phòng ban liên quan</label>
                            <nz-select nzShowSearch nzPlaceHolder="Chọn phòng ban liên quan" nzAllowClear
                                nzSize="default" class="w-100" formControlName="relatedDepartmentId">
                                <nz-option *ngFor="let department of departments" [nzValue]="department.ID"
                                    [nzLabel]="department.Name"></nz-option>
                            </nz-select>
                        </div>
                        <div class="col-md-6 mt-1 ">
                            <label class="mb-0 fs-12">Số chứng từ</label>
                            <nz-select nzMode="multiple" nzShowSearch nzPlaceHolder="Chọn số chứng từ" nzAllowClear
                                nzSize="default" class="w-100" formControlName="documentNumber">
                                <nz-option *ngFor="let item of documents" [nzValue]="item.Code"
                                    [nzLabel]="item.Code + ' - ' + item.SourceTable"></nz-option>
                            </nz-select>
                        </div>
                        <div class="col-md-6 mt-1 ">
                            <label class="mb-0 fs-12">Nhà cung cấp</label>
                            <nz-select nzShowSearch nzPlaceHolder="Chọn nhà cung cấp" nzAllowClear
                                nzSize="default" class="w-100" formControlName="supplierId">
                                <nz-option *ngFor="let supplier of suppliers" [nzValue]="supplier.ID"
                                    [nzLabel]="supplier.NameNCC + ' - ' + supplier.CodeNCC"></nz-option>
                            </nz-select>
                        </div>
                        <div class="col-md-12 mt-1">
                            <label class="mb-0 fs-12">Trạng thái <span class="text-danger ps-1">(*)</span></label>
                            <button class="p-0 m-0 fs-12 px-1 h-auto" nz-button nzType="text" nzSize="small"
                                            title="Thêm trạng thái" (click)="openModalIssueStatus()">
                                            <i class="fas fa-plus"></i>
                                        </button>
                            <nz-select nzShowSearch nzPlaceHolder="Chọn trạng thái" nzAllowClear
                                nzSize="default" class="w-100" formControlName="statusId" (ngModelChange)="onStatusChange()">
                                <nz-option *ngFor="let status of statuses" [nzValue]="status.ID"
                                    [nzLabel]="status.StatusName"></nz-option>
                            </nz-select>
                            <div *ngIf="form.get('statusId')?.invalid && form.get('statusId')?.touched" class="text-danger fs-12 mt-1">
                                <div *ngIf="form.get('statusId')?.errors?.['required']">Trạng thái là bắt buộc</div>
                            </div>
                        </div>
                        <div class="col-md-12 mt-1 ">
                            <label class="mb-0 fs-12">Lý do không đồng ý</label>
                            <textarea class="form-control form-control-sm fs-12" rows="2" formControlName="reasonIgnoreStatusText"></textarea>
                            <div *ngIf="form.get('reasonIgnoreStatusText')?.invalid && form.get('reasonIgnoreStatusText')?.touched" class="text-danger fs-12 mt-1">
                                <div *ngIf="form.get('reasonIgnoreStatusText')?.errors?.['required']">Lý do không đồng ý là bắt buộc</div>
                            </div>
                        </div>
                        <div class="col-md-12 mt-1 ">
                            <label class="mb-0 fs-12">Mô tả lỗi/sự việc <span class="text-danger ps-1">(*)</span></label>
                            <textarea class="form-control form-control-sm fs-12" rows="2" formControlName="issueDescription"></textarea>
                            <div *ngIf="form.get('issueDescription')?.invalid && form.get('issueDescription')?.touched" class="text-danger fs-12 mt-1">
                                <div *ngIf="form.get('issueDescription')?.errors?.['required']">Mô tả lỗi/sự việc là bắt buộc</div>
                            </div>
                        </div>
                        <div class="col-md-12 mt-1 ">
                            <label class="mb-0 fs-12">Phương án khắc phục trước mắt <span class="text-danger ps-1">(*)</span></label>
                            <textarea class="form-control form-control-sm fs-12" rows="2" formControlName="immediateAction"></textarea>
                            <div *ngIf="form.get('immediateAction')?.invalid && form.get('immediateAction')?.touched" class="text-danger fs-12 mt-1">
                                <div *ngIf="form.get('immediateAction')?.errors?.['required']">Phương án khắc phục trước mắt là bắt buộc</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Column 2: Employee Info -->
                <div class="col-md-6">
                    <div class="row g-1">

                        <div class="col-md-6 mt-1">
                            <label class="mb-0 fs-12">Khách hàng <span class="text-danger ps-1">(*)</span></label>
                            <nz-select nzShowSearch nzPlaceHolder="Chọn khách hàng" nzAllowClear
                                nzSize="default" class="w-100" formControlName="customerId">
                                <nz-option *ngFor="let customer of customers" [nzValue]="customer.ID"
                                    [nzLabel]="customer.CustomerCode+ ' - ' + customer.CustomerName"></nz-option>
                            </nz-select>
                            <div *ngIf="form.get('customerId')?.invalid && form.get('customerId')?.touched" class="text-danger fs-12 mt-1">
                                <div *ngIf="form.get('customerId')?.errors?.['required']">Khách hàng là bắt buộc</div>
                            </div>
                        </div>
                        <div class="col-md-6 mt-1">
                            <label class="mb-0 fs-12">Người xác nhận hoàn thành</label>
                            <nz-select nzShowSearch nzPlaceHolder="Chọn người xác nhận hoàn thành" nzAllowClear
                                nzSize="default" class="w-100" formControlName="verifiedBy">
                                <nz-option *ngFor="let employee of employees" [nzValue]="employee.ID"
                                    [nzLabel]="employee.FullName"></nz-option>
                            </nz-select>
                        </div>
                        <div class="col-md-6 mt-1">
                            <label class="mb-0 fs-12">Người chịu trách nhiệm xử lý <span class="text-danger ps-1">(*)</span></label>
                            <nz-select nzShowSearch nzPlaceHolder="Chọn người chịu trách nhiệm xử lý" nzAllowClear
                                nzSize="default" class="w-100" formControlName="employeeId">
                                <nz-option *ngFor="let employee of employees" [nzValue]="employee.ID"
                                    [nzLabel]="employee.FullName"></nz-option>
                            </nz-select>
                            <div *ngIf="form.get('employeeId')?.invalid && form.get('employeeId')?.touched" class="text-danger fs-12 mt-1">
                                <div *ngIf="form.get('employeeId')?.errors?.['required']">Người chịu trách nhiệm xử lý là bắt buộc</div>
                            </div>
                        </div>
                        <div class="col-md-6 mt-1">
                            <label class="mb-0 fs-12">Thời hạn khắc phục <span class="text-danger ps-1">(*)</span></label>
                            <nz-date-picker class="w-100" nzFormat="dd/MM/yyyy" nzAllowClear="false"
                                formControlName="deadline"></nz-date-picker>
                            <div *ngIf="form.get('deadline')?.invalid && form.get('deadline')?.touched" class="text-danger fs-12 mt-1">
                                <div *ngIf="form.get('deadline')?.errors?.['required']">Thời hạn khắc phục là bắt buộc</div>
                            </div>
                        </div>

                        <div class="col-md-12 mt-1">
                            <label class="mb-0 fs-12">Mã dự án <span class="text-danger ps-1">(*)</span></label>
                            <nz-select nzShowSearch nzPlaceHolder="Chọn dự án" nzAllowClear
                                nzSize="default" class="w-100" formControlName="projectId">
                                <nz-option *ngFor="let project of projects" [nzValue]="project.ID"
                                    [nzLabel]="project.ProjectName + '-' + project.ProjectCode"></nz-option>
                            </nz-select>
                            <div *ngIf="form.get('projectId')?.invalid && form.get('projectId')?.touched" class="text-danger fs-12 mt-1">
                                <div *ngIf="form.get('projectId')?.errors?.['required']">Mã dự án là bắt buộc</div>
                            </div>
                        </div>
                        <div class="col-md-12 mt-1">
                            <label class="mb-0 fs-12">Nguyên nhân <span class="text-danger ps-1">(*)</span></label>
                            <button class="p-0 m-0 fs-12 px-1 h-auto" nz-button nzType="text" nzSize="small"
                            title="Thêm nguyên nhân" (click)="openModalIssueCause()">
                            <i class="fas fa-plus"></i>
                        </button>
                            <nz-select nzShowSearch nzPlaceHolder="Chọn nguyên nhân" nzAllowClear
                                nzSize="default" class="w-100" formControlName="issueCauseId" (ngModelChange)="onIssueCauseChange()">
                                <nz-option *ngFor="let issueCause of issueCauses" [nzValue]="issueCause.ID"
                                    [nzLabel]="issueCause.IssueCauseText"></nz-option>
                            </nz-select>
                            <div *ngIf="form.get('issueCauseId')?.invalid && form.get('issueCauseId')?.touched" class="text-danger fs-12 mt-1">
                                <div *ngIf="form.get('issueCauseId')?.errors?.['required']">Nguyên nhân là bắt buộc</div>
                            </div>
                        </div>

                        <div class="col-md-12 mt-1 ">
                            <label class="mb-0 fs-12">Nguyên nhân khác</label>
                            <textarea class="form-control form-control-sm fs-12" rows="2" formControlName="otherIssueCauseNote"></textarea>
                            <div *ngIf="form.get('otherIssueCauseNote')?.invalid && form.get('otherIssueCauseNote')?.touched" class="text-danger fs-12 mt-1">
                                <div *ngIf="form.get('otherIssueCauseNote')?.errors?.['required']">Nguyên nhân khác là bắt buộc</div>
                            </div>
                        </div>

                        <div class="col-md-12 mt-1 ">
                            <label class="mb-0 fs-12">Chi tiết ảnh hưởng/Hậu quả <span class="text-danger ps-1">(*)</span></label>
                            <textarea class="form-control form-control-sm fs-12" rows="2" formControlName="impactDetail"></textarea>
                            <div *ngIf="form.get('impactDetail')?.invalid && form.get('impactDetail')?.touched" class="text-danger fs-12 mt-1">
                                <div *ngIf="form.get('impactDetail')?.errors?.['required']">Chi tiết ảnh hưởng/Hậu quả là bắt buộc</div>
                            </div>
                        </div>

                        <div class="col-md-12 mt-1 ">
                            <label class="mb-0 fs-12">Phương án phòng ngừa lâu dài</label>
                            <textarea class="form-control form-control-sm fs-12" rows="2" formControlName="preventiveAction"></textarea>
                        </div>

                    </div>
                </div>
                <div class="col-md-12 mt-1 ">
                    <label class="mb-0 fs-12">Ghi chú</label>
                    <textarea class="form-control form-control-sm fs-12" rows="4" formControlName="note"></textarea>
                </div>
            </div>
        </form>

        <div class="modal-footer py-1">
            <button nz-button nzType="default" nzDanger="true" nzSize="default" (click)="closeModal()">Đóng</button>
            <button nz-button nzType="primary" nzSize="default" (click)="saveData()">Lưu</button>
        </div>
    </div>