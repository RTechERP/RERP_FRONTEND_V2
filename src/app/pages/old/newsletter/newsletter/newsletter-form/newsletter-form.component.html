<div class="modal-dialog-scrollable">
  <div class="modal-header bg-primary align-items-center p-2">
    <h6 class="text-light text-uppercase m-0 text-center flex-grow-1 ps-4">
      {{ isEditMode ? 'SỬA BẢN TIN' : 'THÊM BẢN TIN MỚI' }}
    </h6>
    <button type="button" class="btn-close" (click)="onCancel()" aria-label="Close"></button>
  </div>

  <div class="modal-body p-3" style="max-height: 85vh; overflow-y: auto; overflow-x: hidden;">
    <form nz-form [formGroup]="newsletterForm" nzLayout="vertical">
      <nz-row [nzGutter]="16">
        <nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="8" [nzXl]="6" *ngIf="isEditMode">
          <nz-form-item>
            <nz-form-label>Mã bản tin</nz-form-label>
            <nz-form-control>
              <input formControlName="Code" placeholder="Tự động tạo" nz-input readonly />
            </nz-form-control>
          </nz-form-item>
        </nz-col>

        <nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="8" [nzXl]="6">
          <nz-form-item>
            <nz-form-label>Loại bản tin<span class="text-danger ps-1"> (*)</span></nz-form-label>
            <nz-form-control [nzErrorTip]="'Vui lòng chọn loại bản tin'">
              <nz-select formControlName="Type" placeholder="Chọn loại bản tin" [nzLoading]="typeList.length === 0">
                <nz-option *ngFor="let type of typeList" [nzValue]="type.ID"
                  [nzLabel]="type.NewsletterTypeName"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </nz-col>
      </nz-row>

      <nz-row [nzGutter]="16">
        <nz-col [nzXs]="24" [nzSm]="24" [nzMd]="24" [nzLg]="24" [nzXl]="24">
          <nz-form-item>
            <nz-form-label>Tiêu đề<span class="text-danger ps-1"> (*)</span></nz-form-label>
            <nz-form-control [nzErrorTip]="'Vui lòng nhập tiêu đề'">
              <textarea formControlName="Title" placeholder="Nhập tiêu đề bản tin"
                style="width: 100%; min-height: 40px; height: auto; resize: none; padding: 10px; border-radius: 4px; border: 1px solid #d9d9d9;"
                rows="2" (input)="autoResizeTextarea($event)"></textarea>
            </nz-form-control>
          </nz-form-item>
        </nz-col>
      </nz-row>

      <nz-row [nzGutter]="16">
        <nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="12" [nzXl]="12">
          <nz-form-item>
            <nz-form-label>Ảnh đại diện</nz-form-label>
            <nz-form-control>
              <div class="d-flex flex-column gap-2">
                <div class="d-flex flex-column flex-sm-row gap-2">
                  <nz-upload nzAccept="image/*" [nzFileList]="[]" [nzBeforeUpload]="beforeUploadImage"
                    [nzShowUploadList]="false" [nzMultiple]="false">
                    <button nz-button nzBlock class="w-100 w-sm-auto">
                      <span nz-icon nzType="upload"></span>
                      Chọn ảnh
                    </button>
                  </nz-upload>
                  <input nz-input [value]="attachImageName || ''" placeholder="Chưa chọn ảnh" readonly
                    style="flex: 1" />
                  <button *ngIf="attachImageName" nz-button nzType="default" nzSize="small" (click)="removeImage()">
                    <span nz-icon nzType="delete" nzTheme="outline"></span>
                  </button>
                </div>
                <!-- Hiển thị ảnh hiện có khi edit hoặc ảnh mới vừa chọn -->
                <div *ngIf="getImageUrl() || selectedImageFile" class="mt-2 text-center border rounded p-2 bg-light">
                  <img [src]="newImagePreviewUrl || getImageUrl()" alt="Ảnh đại diện"
                    style="max-width: 100%; max-height: 200px; object-fit: contain;" class="rounded shadow-sm">
                  <div *ngIf="selectedImageFile" class="small text-success mt-1 fw-bold">
                    <i nz-icon nzType="check-circle" nzTheme="outline"></i> Sẵn sàng upload: {{attachImageName}}
                  </div>
                </div>
              </div>
            </nz-form-control>
          </nz-form-item>
        </nz-col>

        <nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="12" [nzXl]="12">
          <nz-form-item>
            <nz-form-label>File đính kèm</nz-form-label>
            <nz-form-control>
              <div class="d-flex flex-column gap-2">
                <div class="d-flex flex-column flex-sm-row gap-2">
                  <nz-upload [nzFileList]="[]" [nzBeforeUpload]="beforeUploadFiles" [nzShowUploadList]="false"
                    [nzMultiple]="true">
                    <button nz-button nzBlock class="w-100 w-sm-auto">
                      <span nz-icon nzType="upload"></span>
                      Chọn file
                    </button>
                  </nz-upload>
                  <input nz-input [value]="attachFileNames || ''" placeholder="Chưa chọn file" readonly
                    style="flex: 1" />
                  <button *ngIf="attachFileNames" nz-button nzType="default" nzSize="small" (click)="removeFiles()">
                    <span nz-icon nzType="delete" nzTheme="outline"></span>
                  </button>
                </div>

                <!-- Danh sách file hiện có (khi edit mode) -->
                <div *ngIf="existingFiles.length > 0" class="mt-2">
                  <small class="text-muted fw-bold">Duyệt danh sách file:</small>
                  <div class="existing-files-list mt-1" style="max-height: 150px; overflow-y: auto;">
                    <div *ngFor="let file of existingFiles"
                      class="d-flex align-items-center gap-2 mb-1 p-2 border rounded bg-light"
                      [style.opacity]="deletedFileIds.includes(file.ID!) ? '0.5' : '1'">
                      <i nz-icon nzType="file" nzTheme="outline" class="text-primary"></i>
                      <span class="flex-grow-1 text-truncate"
                        [style.text-decoration]="deletedFileIds.includes(file.ID!) ? 'line-through' : 'none'"
                        [title]="file.FileName">
                        {{ file.FileName }}
                      </span>
                      <div class="d-flex gap-1">
                        <button *ngIf="!deletedFileIds.includes(file.ID!)" nz-button nzType="text" nzSize="small"
                          (click)="viewFile(file)" title="Xem file">
                          <i nz-icon nzType="eye" nzTheme="outline"></i>
                        </button>
                        <button *ngIf="!deletedFileIds.includes(file.ID!)" nz-button nzType="text" nzSize="small"
                          nzDanger (click)="deleteExistingFile(file)" title="Xóa file">
                          <span nz-icon nzType="delete" nzTheme="outline"></span>
                        </button>
                        <button *ngIf="deletedFileIds.includes(file.ID!)" nz-button nzType="text" nzSize="small"
                          (click)="deleteExistingFile(file)" title="Hoàn tác">
                          <span nz-icon nzType="undo" nzTheme="outline"></span>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </nz-form-control>
          </nz-form-item>
        </nz-col>
      </nz-row>

      <nz-row [nzGutter]="16">
        <nz-col [nzXs]="24" [nzSm]="24" [nzMd]="24" [nzLg]="24" [nzXl]="24">
          <nz-form-item>
            <nz-form-label>Nội dung<span class="text-danger ps-1"> (*)</span></nz-form-label>
            <nz-form-control [nzErrorTip]="'Vui lòng nhập nội dung'">
              <p-editor #editor formControlName="NewsletterContent"
                [style]="{'height': '400px', 'margin-bottom': '10px'}" [modules]="editorModules">
                <ng-template pTemplate="header">
                  <span class="ql-formats">
                    <select class="ql-header">
                      <option value="1">Heading 1</option>
                      <option value="2">Heading 2</option>
                      <option selected>Normal</option>
                    </select>
                    <select class="ql-font">
                      <option value="arial" selected>Arial</option>
                      <option value="times-new-roman">Times New Roman</option>
                      <option value="courier-new">Courier New</option>
                      <option value="tahoma">Tahoma</option>
                      <option value="verdana">Verdana</option>
                      <option value="georgia">Georgia</option>
                      <option value="comic-sans-ms">Comic Sans MS</option>
                      <option value="impact">Impact</option>
                      <option value="arial-black">Arial Black</option>
                    </select>
                  </span>
                  <span class="ql-formats">
                    <button class="ql-bold"></button>
                    <button class="ql-italic"></button>
                    <button class="ql-underline"></button>
                    <button class="ql-strike"></button>
                  </span>
                  <span class="ql-formats">
                    <select class="ql-color"></select>
                    <select class="ql-background"></select>
                  </span>
                  <span class="ql-formats">
                    <button class="ql-list" value="ordered"></button>
                    <button class="ql-list" value="bullet"></button>
                    <button class="ql-indent" value="-1"></button>
                    <button class="ql-indent" value="+1"></button>
                  </span>
                  <span class="ql-formats">
                    <button class="ql-link"></button>
                    <button class="ql-video"></button>
                  </span>
                  <span class="ql-formats">
                    <button class="ql-clean"></button>
                  </span>
                </ng-template>
              </p-editor>
            </nz-form-control>
          </nz-form-item>
        </nz-col>
      </nz-row>
    </form>
  </div>

  <div class="modal-footer bg-white p-2 d-flex justify-content-end gap-2">
    <button nz-button nzDanger nzType="default" (click)="onCancel()" [nzLoading]="isLoading">
      Đóng
    </button>
    <button nz-button nzType="primary" (click)="onSubmit()" [nzLoading]="isLoading">
      Lưu
    </button>
  </div>
</div>