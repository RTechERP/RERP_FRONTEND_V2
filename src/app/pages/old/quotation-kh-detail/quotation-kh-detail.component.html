<!-- quotation-kh-detail.component.html -->
<div class="modal-header bg-primary text-uppercase py-2">
    <h6 class="modal-title text-white">BÁO GIÁ KHÁCH HÀNG CHI TIẾT</h6>
    <button type="button" class="btn-close" (click)="closeModal()" aria-label="Close"></button>
</div>

<div class="modal-body p-1">
    <div class="d-flex gap-1 mb-2">
        <!-- <button class="fs-12" nz-button nzType="default" nzSize="small" title="Đính kèm file">
            <nz-icon nzType="paper-clip"></nz-icon> Đính kèm file
        </button>
        <button class="fs-12" nz-button nzType="default" nzSize="small" title="Nhập File">
            <nz-icon nzType="upload"></nz-icon> Nhập File
        </button> -->
        <button class="fs-12" nz-button nzType="default" nzSize="small" title="Kiểm tra tồn kho">
            <nz-icon nzType="search"></nz-icon> Kiểm tra tồn kho
        </button>
    </div>
    <form [formGroup]="quotationForm">
        <div class="container-fluid">
            <div class="row g-2">
                <div class="col-md-2">
                    <label class="mb-0 fs-12 d-inline"><span>Trạng thái</span> <span
                            class="text-danger">*</span></label>
                    <nz-select nzShowSearch nzPlaceHolder="Chọn trạng thái" nzAllowClear nzSize="default" class="w-100"
                        formControlName="status">
                        <nz-option *ngFor="let status of statusOptions" [nzValue]="status.value"
                            [nzLabel]="status.label"></nz-option>
                    </nz-select>
                    <small class="text-danger" *ngIf="isSubmitted && quotationForm.get('status')?.invalid">
                        Vui lòng chọn trạng thái báo giá
                    </small>
                </div>
                <div class="col-md-2">
                    <label class="mb-0 fs-12 d-inline"><span>Mã</span> <span class="text-danger">*</span></label>
                    <input type="text" class="form-control form-control-sm fs-12" formControlName="code">
                    <small class="text-danger" *ngIf="isSubmitted && quotationForm.get('code')?.invalid">
                        Vui lòng điền mã báo giá
                    </small>
                </div>
                <div class="col-md-2">
                    <label class="mb-0 fs-12">Số PO</label>
                    <input type="text" class="form-control form-control-sm fs-12" formControlName="poCode">
                </div>
                <div class="col-md-2">
                    <label class="mb-0 fs-12">Ngày tạo</label>
                    <input type="date" class="form-control form-control-sm fs-12" formControlName="createDate">
                </div>
                <div class="col-md-2">
                    <label class="mb-0 fs-12">Ngày báo giá</label>
                    <input type="date" class="form-control form-control-sm fs-12" formControlName="quotationDate">
                </div>
                <div class="col-md-2">
                    <label class="mb-0 fs-12">Công ty</label>
                    <nz-select nzShowSearch nzPlaceHolder="Chọn công ty" nzAllowClear nzSize="default" class="w-100"
                        formControlName="company">
                        <nz-option *ngFor="let company of companyOptions" [nzValue]="company.value"
                            [nzLabel]="company.label"></nz-option>
                    </nz-select>
                </div>
            </div>
            <div class="row g-2 mt-1">
                <div class="col-md-2">
                    <label class="mb-0 fs-12">Tổng báo giá</label>
                    <nz-input-number nzPlaceHolder="0" [nzMin]="0" nzSize="default" class="w-100"
                        formControlName="totalPrice" [nzFormatter]="formatCurrency" [nzParser]="parseCurrency"
                        nzReadOnly="true">
                    </nz-input-number>
                </div>
                <div class="col-md-2">
                    <label class="mb-0 fs-12">Giải trình Fail</label>
                    <input type="text" class="form-control form-control-sm fs-12" formControlName="explanation">
                </div>
                <div class="col-md-2">
                    <label class="mb-0 fs-12">SĐT liên hệ</label>
                    <input type="text" class="form-control form-control-sm fs-12" formControlName="customerPhone">
                </div>
                <div class="col-md-2">
                    <label class="mb-0 fs-12">Tiền COM</label>
                    <nz-input-number nzPlaceHolder="0" [nzMin]="0" nzSize="default" class="w-100"
                        formControlName="comMoney" [nzFormatter]="formatCurrency" [nzParser]="parseCurrency"
                        nzReadOnly="true">
                    </nz-input-number>
                </div>
                <div class="col-md-2">
                    <label class="mb-0 fs-12 d-inline"><span>Người phụ trách</span> <span
                            class="text-danger">*</span></label>
                    <nz-select nzShowSearch nzPlaceHolder="Chọn người phụ trách" nzAllowClear nzSize="default"
                        class="w-100" formControlName="userId">
                        <nz-option *ngFor="let item of Users" [nzValue]="item.ID" [nzLabel]="item.FullName"></nz-option>
                    </nz-select>
                    <small class="text-danger" *ngIf="isSubmitted && quotationForm.get('userId')?.invalid">
                        Vui lòng chọn người phụ trách
                    </small>
                </div>
                <div class="col-md-2">
                    <label class="mb-0 fs-12">Người liên hệ</label>
                    <nz-select nzShowSearch nzPlaceHolder="Chọn người liên hệ" nzAllowClear nzSize="default"
                        class="w-100" formControlName="contactId">
                        <nz-option *ngFor="let item of contact" [nzValue]="item.ID"
                            [nzLabel]="item.ContactName"></nz-option>
                    </nz-select>
                </div>
            </div>
            <div class="row g-2 mt-2">
                <div class="col-12 col-md-4">
                    <label class="mb-0 fs-12 d-inline"><span>Khách hàng</span> <span class="text-danger">*</span>
                        <button class="p-0 m-0 px-1 fs-12 h-auto" nz-button nzType="text" nzSize="small"
                            title="Thêm khách hàng" (click)="onAddCustomer()">
                            <i class="fas fa-plus"></i>
                        </button></label>
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <nz-select nzShowSearch nzPlaceHolder="Chọn khách hàng" nzAllowClear nzSize="default"
                                class="w-100" formControlName="customerId">
                                <nz-option *ngFor="let customer of customers" [nzValue]="customer.ID"
                                    [nzLabel]="customer.CustomerShortName"></nz-option>
                            </nz-select>
                            <small class="text-danger" *ngIf="isSubmitted && quotationForm.get('customerId')?.invalid">
                                Vui lòng chọn một khách hàng
                            </small>
                        </div>
                        <!-- <button nz-button nzType="default" nzSize="small" (click)="onAddCustomer()">
                            <nz-icon nzType="plus" nzTheme="outline"></nz-icon>
                        </button> -->

                    </div>
                </div>
                <div class="col-12 col-md-4">
                    <label class="mb-0 fs-12">Dự án
                        <button class="p-0 m-0 px-1 fs-12 h-auto" nz-button nzType="text" nzSize="small"
                            title="Thêm khách hàng" (click)="onAddProject()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </label>
                    <div class="d-flex align-items-center">
                        <nz-select nzShowSearch nzPlaceHolder="Chọn dự án" nzAllowClear nzSize="default" class="w-100"
                            formControlName="projectId">
                            <nz-option *ngFor="let item of projects" [nzValue]="item.ID"
                                [nzLabel]="item.ProjectCode + ' - ' + item.ProjectName">
                            </nz-option>
                        </nz-select>
                        <!-- <button nz-button nzType="default" nzSize="small" (click)="onAddProject()">
                            <nz-icon nzType="plus" nzTheme="outline"></nz-icon>
                        </button> -->
                    </div>
                </div>
                <div class="col-12 col-md-4">
                    <label class="mb-0 fs-12">COM (%)</label>
                    <div class="d-flex align-items-center">
                        <input type="checkbox" formControlName="comEnabled" class="me-1" />
                        <input type="number" class="form-control form-control-sm fs-12" formControlName="comPercent">
                    </div>
                </div>
            </div>
            <!-- Bảng sản phẩm chi tiết -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="d-flex align-items-center gap-3 mb-2">
                        <button nz-button nzType="primary" nzSize="small" (click)="addNewRow()">
                            <nz-icon nzType="plus"></nz-icon> Thêm dòng
                        </button>
                        <div class="d-flex align-items-center">
                            <label class="d-flex align-items-center mb-0 fs-12" style="cursor: pointer;">
                                <input type="checkbox" [(ngModel)]="showRTCCode"
                                    (change)="onRTCCodeToggle($any($event.target).checked)" class="me-2"
                                    style="width: 16px; height: 16px; cursor: pointer;" />
                                Search sản phẩm
                            </label>
                        </div>
                    </div>
                </div>
                <div #tb_MainTable id="tb_MainTable"></div>
            </div>
        </div>
    </form>
    <div class="modal-footer py-1">
        <button nz-button nzType="default" nzDanger="true" nzSize="default" (click)="closeModal()">Đóng</button>
        <button nz-button nzType="primary" nzSize="default" (click)="saveAndClose()">Lưu</button>
    </div>
</div>