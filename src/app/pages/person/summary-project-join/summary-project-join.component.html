<ng-container class="w-100">
    <nz-splitter style="height: 94vh!important;">
        <!-- Panel tìm kiếm (có thể ẩn) -->
        <nz-splitter-panel [nzSize]="sizeSearch" nzResizable="false">
            <div class="card h-100 border-0 rounded-0">
                <div class="card-header bg-white p-1">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="m-0 ms-2">Tìm kiếm</h6>
                        <button class="border-0 me-2" nz-button nzSize="small" nzType="default" nzDanger
                            (click)="toggleSearchPanel()">
                            <nz-icon nzType="close" nzTheme="outline"></nz-icon>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <form nz-form nzLayout="vertical">
                        <nz-form-item>
                            <nz-form-label class="fs-12" [nzSpan]="24">Từ ngày</nz-form-label>
                            <nz-form-control [nzSpan]="24">
                                <nz-date-picker name="dateStart" class="w-100" nzSize="small"
                                    nzFormat="dd/MM/yyyy" [(ngModel)]="dateStart" nzAllowClear="false">
                                </nz-date-picker>
                            </nz-form-control>
                        </nz-form-item>
                        <nz-form-item class="mt-2">
                            <nz-form-label class="fs-12" [nzSpan]="24">Đến ngày</nz-form-label>
                            <nz-form-control [nzSpan]="24">
                                <nz-date-picker name="dateEnd" class="w-100" nzSize="small"
                                    nzFormat="dd/MM/yyyy" [(ngModel)]="dateEnd" nzAllowClear="false">
                                </nz-date-picker>
                            </nz-form-control>
                        </nz-form-item>
                        <nz-form-item class="mt-2">
                            <nz-form-label class="fs-12" [nzSpan]="24">Nhân viên</nz-form-label>
                            <nz-form-control [nzSpan]="24">
                                <nz-select name="technicalId" class="w-100" nzSize="small" nzShowSearch nzAllowClear
                                    nzPlaceHolder="Chọn nhân viên" [(ngModel)]="technicalId">
                                    @for (parent of users; track $index) {
                                    <nz-option-group [nzLabel]="parent.label">
                                        @for (child of parent.options; track $index) {
                                        <nz-option [nzLabel]="child.item.FullName" [nzValue]="child.item.ID">
                                            {{ child.item.Code + " - " + child.item.FullName }}
                                        </nz-option>
                                        }
                                    </nz-option-group>
                                    }
                                </nz-select>
                            </nz-form-control>
                        </nz-form-item>
                        <nz-form-item class="mt-2">
                            <nz-form-label class="fs-12" [nzSpan]="24">Từ khóa</nz-form-label>
                            <nz-form-control [nzSpan]="24">
                                <input nz-input placeholder="Nhập từ khóa" nzSize="small" [(ngModel)]="keyword"
                                    name="keyword" />
                            </nz-form-control>
                        </nz-form-item>
                    </form>
                </div>
                <div class="card-footer bg-white p-1 d-flex gap-1 justify-content-end">
                    <button nz-button nzType="default" nzSize="small" (click)="clearAllFilters()">Đặt lại</button>
                    <button nz-button nzType="primary" nzSize="small" (click)="searchProjects()">Tìm kiếm</button>
                </div>
            </div>
        </nz-splitter-panel>

        <!-- Panel chính -->
        <nz-splitter-panel nzDefaultSize="100%">
            <div class="card h-100 border-0 rounded-0">
                <div class="card-header bg-white p-1">
                    <nav class="navbar navbar-expand-md navbar-light p-0">
                        <button class="navbar-toggler mb-2" type="button" data-bs-toggle="collapse"
                            data-bs-target="#projectToolbar" aria-controls="projectToolbar" aria-expanded="false"
                            aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon border-radius-0"></span>
                        </button>

                        <div class="collapse navbar-collapse" id="projectToolbar">
                            <div class="d-flex flex-wrap gap-1 align-items-center">
                                <button nz-button nzType="default" nzSize="small" (click)="toggleSearchPanel()">
                                    <nz-icon nzType="search"></nz-icon>
                                </button>

                                <button class="fs-12" nz-button nzType="default" nzSize="small" (click)="exportExcel()">
                                    <img src="assets/icon/action_export_excel_16.png" alt="Xuất excel" />Xuất Excel
                                </button>

                                <button 
                                    class="fs-12" 
                                    nz-button 
                                    nzSize="small"
                                    [nzType]="showProjectDetail ? 'primary' : 'default'"
                                    (click)="toggleProjectDetail()"
                                >
                                    <nz-icon [nzType]="showProjectDetail ? 'eye' : 'eye-invisible'" />
                                    {{ showProjectDetail ? 'Ẩn' : 'Hiện' }} chi tiết
                                </button>
                            </div>
                        </div>
                    </nav>
                </div>
                
                <div class="card-body p-0" style="height: calc(100vh - 150px); display: flex; flex-direction: column;">
                    <nz-splitter nzLayout="vertical" style="height: 100%; flex: 1;">
                        <!-- Phần trên: 2 bảng ngang -->
                        <nz-splitter-panel [nzCollapsible]="false" [nzResizable]="false" [nzSize]="showProjectDetail ? '60%' : '100%'">
                            <nz-splitter style="height: 100%;">
                                <!-- Bảng trái: Danh sách tham gia dự án -->
                                <nz-splitter-panel nzDefaultSize="50%" nzResizable="true">
                                    <div style="height: 100%; display: flex; flex-direction: column;">
                                        <div class="grid-header">
                                            <h6 class="m-0 p-2">Danh sách tham gia dự án</h6>
                                        </div>
                                        <div class="grid-container" id="grid-container-projects" style="flex: 1; height: 100%;">
                                            <angular-slickgrid
                                                gridId="grvProjects"
                                                [columns]="columnDefinitionsProjects"
                                                [options]="gridOptionsProjects"
                                                [dataset]="datasetProjects"
                                                (onAngularGridCreated)="angularGridProjectsReady($event.detail)"
                                                (onSelectedRowsChanged)="handleRowSelectionProjects($event.detail.eventData, $event.detail.args)"
                                                (onClick)="onCellClickedProjects($event.detail.eventData, $event.detail.args)">
                                            </angular-slickgrid>
                                        </div>
                                    </div>
                                </nz-splitter-panel>

                                <!-- Bảng phải: Danh sách đã tham gia -->
                                <nz-splitter-panel nzDefaultSize="50%" nzResizable="true">
                                    <div style="height: 100%; display: flex; flex-direction: column;">
                                        <div class="grid-header">
                                            <h6 class="m-0 p-2">Danh sách đã tham gia</h6>
                                        </div>
                                        <div class="grid-container" id="grid-container-project-employee" style="flex: 1; height: 100%;">
                                            <angular-slickgrid
                                                gridId="grvProjectEmployee"
                                                [columns]="columnDefinitionsProjectEmployee"
                                                [options]="gridOptionsProjectEmployee"
                                                [dataset]="datasetProjectEmployee"
                                                (onAngularGridCreated)="angularGridProjectEmployeeReady($event.detail)"
                                                (onSelectedRowsChanged)="handleRowSelectionProjectEmployee($event.detail.eventData, $event.detail.args)">
                                            </angular-slickgrid>
                                        </div>
                                    </div>
                                </nz-splitter-panel>
                            </nz-splitter>
                        </nz-splitter-panel>

                        <!-- Phần dưới: Tab chi tiết -->
                        <nz-splitter-panel [nzCollapsible]="false" [nzResizable]="false" [nzSize]="showProjectDetail ? '40%' : '0%'">
                            <div style="height: 100%; display: flex; flex-direction: column;" *ngIf="detailGridsReady">
                                <nz-tabset style="padding-left: 10px; flex: 1; display: flex; flex-direction: column; min-height: 0;">
                                    <nz-tab nzTitle="Danh sách hạng mục" style="height: 100%;">
                                        <div id="grid-container-project-work-reports" style="height: 100%; width: 100%;">
                                            <angular-slickgrid
                                                gridId="grvProjectWorkReports"
                                                [columns]="columnDefinitionsProjectWorkReports"
                                                [options]="gridOptionsProjectWorkReports"
                                                [dataset]="datasetProjectWorkReports"
                                                (onAngularGridCreated)="angularGridProjectWorkReportsReady($event.detail)">
                                            </angular-slickgrid>
                                        </div>
                                    </nz-tab>
                                    <nz-tab nzTitle="Kiểu dự án" style="height: 100%;">
                                        <div id="grid-container-project-type-links" style="height: 100%; width: 100%;">
                                            <angular-slickgrid
                                                gridId="grvProjectTypeLinks"
                                                [columns]="columnDefinitionsProjectTypeLinks"
                                                [options]="gridOptionsProjectTypeLinks"
                                                [dataset]="datasetProjectTypeLinks"
                                                (onAngularGridCreated)="angularGridProjectTypeLinksReady($event.detail)">
                                            </angular-slickgrid>
                                        </div>
                                    </nz-tab>
                                </nz-tabset>
                            </div>
                        </nz-splitter-panel>
                    </nz-splitter>
                </div>
            </div>
        </nz-splitter-panel>
    </nz-splitter>
</ng-container>
