<ng-container class="w-100">
    <div class="card border-0 rounded-0 h-100" style="height: 94vh !important;">
        <div class="card-header bg-white p-1">
            <div class="d-flex gap-1 align-items-center">
                <button class="fs-12" nz-button nzType="default" nzSize="small" (click)="exportExcel()">
                    <img src="assets/icon/action_export_excel_16.png" alt="Xuất excel" />Xuất Excel
                </button>

                <button class="fs-12" nz-button nzSize="small" [nzType]="showProjectDetail ? 'primary' : 'default'"
                    (click)="toggleProjectDetail()">
                    <nz-icon [nzType]="showProjectDetail ? 'eye' : 'eye-invisible'" />
                    {{ showProjectDetail ? 'Ẩn' : 'Hiện' }} chi tiết
                </button>
            </div>
        </div>

        <!-- Filter bar ngang -->
        <div class="filter-bar bg-light border-bottom p-2">
            <form nz-form class="mobile-filter-form">
                <nz-row [nzGutter]="[8, 8]" nzAlign="bottom">
                    <!-- Từ ngày -->
                    <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="4" [nzXl]="3">
                        <nz-form-item class="mb-0">
                            <nz-form-label class="fs-12" style="font-size: 12px;">Từ ngày</nz-form-label>
                            <nz-form-control class="w-100">
                                <input type="date" name="dateStart" class="form-control form-control-sm w-100"
                                    [(ngModel)]="dateStart" />
                            </nz-form-control>
                        </nz-form-item>
                    </nz-col>

                    <!-- Đến ngày -->
                    <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="4" [nzXl]="3">
                        <nz-form-item class="mb-0">
                            <nz-form-label class="fs-12" style="font-size: 12px;">Đến ngày</nz-form-label>
                            <nz-form-control class="w-100">
                                <input type="date" name="dateEnd" class="form-control form-control-sm w-100"
                                    [(ngModel)]="dateEnd" />
                            </nz-form-control>
                        </nz-form-item>
                    </nz-col>

                    <!-- Nhân viên -->
                    <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="5" [nzXl]="4">
                        <nz-form-item class="mb-0">
                            <nz-form-label class="fs-12" style="font-size: 12px;">Nhân viên</nz-form-label>
                            <nz-form-control class="w-100">
                                <nz-select name="technicalId" class="w-100" nzSize="small" nzShowSearch nzAllowClear
                                    nzPlaceHolder="Chọn nhân viên" [(ngModel)]="technicalId">
                                    @for (parent of users; track $index) {
                                    <nz-option-group [nzLabel]="parent.label">
                                        @for (child of parent.options; track $index) {
                                        <nz-option [nzLabel]="child.item.FullName" [nzValue]="child.item.EmployeeID">
                                            {{ child.item.Code + " - " + child.item.FullName }}
                                        </nz-option>
                                        }
                                    </nz-option-group>
                                    }
                                </nz-select>
                            </nz-form-control>
                        </nz-form-item>
                    </nz-col>

                    <!-- Từ khóa và nút tìm kiếm -->
                    <nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="6" [nzXl]="4">
                        <nz-form-item class="mb-0">
                            <nz-form-label class="fs-12" style="font-size: 12px;">Từ khóa</nz-form-label>
                            <nz-form-control class="w-100">
                                <div class="d-flex gap-1">
                                    <input nz-input placeholder="Nhập từ khóa..." nzSize="small" [(ngModel)]="keyword"
                                        name="keyword" class="flex-grow-1" (keyup.enter)="searchProjects()" />
                                    <button nz-button nzType="primary" style="width: 40px;" nzSize="small"
                                        (click)="searchProjects()">
                                        <nz-icon nzType="search" />
                                    </button>
                                </div>
                            </nz-form-control>
                        </nz-form-item>
                    </nz-col>
                </nz-row>
            </form>
        </div>

        <!-- Content -->
        <div class="card-body p-0" [class.with-search-bar]="shouldShowSearchBar"
            [class.without-search-bar]="!shouldShowSearchBar">
            <div style="height: 100%;">
                <ng-container *ngIf="splitterKey">
                    <nz-splitter nzLayout="vertical" style="height: 83vh !important;">
                        <!-- Phần trên: 2 bảng ngang -->
                        <nz-splitter-panel [nzResizable]="true" [nzDefaultSize]="showProjectDetail ? '50%' : '83vh'">
                            <nz-splitter style="height: 100% !important;">
                                <!-- Bảng trái: Danh sách tham gia dự án -->
                                <nz-splitter-panel nzDefaultSize="50%" nzResizable="true">
                                    <div style="height: 100% !important; display: flex; flex-direction: column;">
                                        <div class="grid-header">
                                            <h6 class="m-0 p-2">DỰ ÁN ĐÃ THAM GIA</h6>
                                        </div>
                                        <div class="grid-container" id="grid-container-projects"
                                            style="flex: 1; min-height: 0;">
                                            <angular-slickgrid gridId="grvProjects"
                                                [columns]="columnDefinitionsProjects" [options]="gridOptionsProjects"
                                                [dataset]="datasetProjects"
                                                (onAngularGridCreated)="angularGridProjectsReady($event.detail)"
                                                (onSelectedRowsChanged)="handleRowSelectionProjects($event.detail.eventData, $event.detail.args)"
                                                (onClick)="onCellClickedProjects($event.detail.eventData, $event.detail.args)">
                                            </angular-slickgrid>
                                        </div>
                                    </div>
                                </nz-splitter-panel>

                                <!-- Bảng phải: Danh sách đã tham gia -->
                                <nz-splitter-panel nzDefaultSize="50%" nzResizable="true">
                                    <div style="height: 100% !important; display: flex; flex-direction: column;">
                                        <div class="grid-header">
                                            <h6 class="m-0 p-2">DỰ ÁN THỰC TẾ</h6>
                                        </div>
                                        <div class="grid-container" id="grid-container-project-employee"
                                            style="flex: 1; height: 100%;">
                                            <angular-slickgrid gridId="grvProjectEmployee"
                                                [columns]="columnDefinitionsProjectEmployee"
                                                [options]="gridOptionsProjectEmployee"
                                                [dataset]="datasetProjectEmployee"
                                                (onAngularGridCreated)="angularGridProjectEmployeeReady($event.detail)"
                                                (onSelectedRowsChanged)="handleRowSelectionProjectEmployee($event.detail.eventData, $event.detail.args)">
                                            </angular-slickgrid>
                                        </div>
                                    </div>
                                </nz-splitter-panel>
                            </nz-splitter>
                        </nz-splitter-panel>

                        <!-- Phần dưới: THÔNG TIN DỰ ÁN (split horizontal như WinForms) -->
                        <nz-splitter-panel [nzResizable]="true" [nzDefaultSize]="showProjectDetail ? '50%' : '0%'">
                            <div style="height: 100% !important; display: flex; flex-direction: column;"
                                *ngIf="detailGridsReady && showProjectDetail">
                                <!-- Header: THÔNG TIN DỰ ÁN -->
                                <div class="detail-header">
                                    <h6 class="m-0 p-2">THÔNG TIN DỰ ÁN</h6>
                                </div>
                                <!-- Content: Split horizontal (Leader | Hạng mục công việc) -->
                                <nz-splitter style="height: 100% !important;">
                                    <!-- Bảng trái: Leader (tlProjectTypeMaster) -->
                                    <nz-splitter-panel nzDefaultSize="30%" nzResizable="true">
                                        <div style="height: 100%; display: flex; flex-direction: column;">
                                            <div class="grid-header">
                                                <h6 class="m-0 p-2">Leader</h6>
                                            </div>
                                            <div class="grid-container" id="grid-container-project-type-links"
                                                style="flex: 1; height: 100%; width: 100%;">
                                                <angular-slickgrid gridId="grvProjectTypeLinks"
                                                    [columns]="columnDefinitionsProjectTypeLinks"
                                                    [options]="gridOptionsProjectTypeLinks"
                                                    [dataset]="datasetProjectTypeLinks"
                                                    (onAngularGridCreated)="angularGridProjectTypeLinksReady($event.detail)">
                                                </angular-slickgrid>
                                            </div>
                                        </div>
                                    </nz-splitter-panel>
                                    <!-- Bảng giữa: Hạng mục công việc (grdProjectItem) -->
                                    <nz-splitter-panel nzDefaultSize="40%" nzResizable="true">
                                        <div style="height: 100% !important; display: flex; flex-direction: column;">
                                            <div class="grid-header">
                                                <h6 class="m-0 p-2">Hạng mục công việc</h6>
                                            </div>
                                            <div class="grid-container" id="grid-container-project-work-reports"
                                                style="flex: 1; height: 100%;">
                                                <angular-slickgrid gridId="grvProjectWorkReports"
                                                    [columns]="columnDefinitionsProjectWorkReports"
                                                    [options]="gridOptionsProjectWorkReports"
                                                    [dataset]="datasetProjectWorkReports"
                                                    (onAngularGridCreated)="angularGridProjectWorkReportsReady($event.detail)">
                                                </angular-slickgrid>
                                            </div>
                                        </div>
                                    </nz-splitter-panel>
                                    <!-- Bảng phải: Hiện trạng (grdProjectCurrentSituation) -->
                                    <nz-splitter-panel nzDefaultSize="30%" nzResizable="true">
                                        <div style="height: 100% !important; display: flex; flex-direction: column;">
                                            <div class="grid-header">
                                                <h6 class="m-0 p-2">Hiện trạng</h6>
                                            </div>
                                            <div class="grid-container" id="grid-container-current-situation"
                                                style="flex: 1; height: 100%;">
                                                <angular-slickgrid gridId="grvCurrentSituation"
                                                    [columns]="columnDefinitionsCurrentSituation"
                                                    [options]="gridOptionsCurrentSituation"
                                                    [dataset]="datasetCurrentSituation"
                                                    (onAngularGridCreated)="angularGridCurrentSituationReady($event.detail)">
                                                </angular-slickgrid>
                                            </div>
                                        </div>
                                    </nz-splitter-panel>
                                </nz-splitter>
                            </div>
                        </nz-splitter-panel>
                    </nz-splitter>
                </ng-container>
            </div>
        </div>
    </div>
</ng-container>