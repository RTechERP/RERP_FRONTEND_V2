<div style="display: flex; flex-direction: column; height: 100vh">
    <!-- Modal Header -->
    <div
      class="modal-header bg-primary align-items-center ps-2"
      style="flex-shrink: 0"
    >
      <h6 class="text-light text-uppercase m-0" style="padding: 0 0.5rem">
        Danh mục vật tư dự án {{ projectCodex }}
      </h6>
      <button
        type="button"
        class="btn-close"
        (click)="activeModal.dismiss()"
        aria-label="Close"
      ></button>
    </div>
  
    <!-- Modal Body -->
    <div class="modal-body p-0" style="overflow: hidden; min-height: 0;">
      <nz-splitter nzLayout="horizontal" style="height: 100%; min-height: 0;">
        <!-- Phần trái: 3 bảng dọc -->
        <nz-splitter-panel nzDefaultSize="25%" nzMin="20%" nzMax="50%">
          <nz-splitter nzLayout="vertical" style="height: 100%">
            <!-- Bảng 1: Giải pháp -->
            <nz-splitter-panel nzDefaultSize="33.33%">
              <div class="card h-100 border-0 rounded-0 d-flex flex-column">
                <div class="card-header bg-white p-1">
                  <p class="m-0">Giải pháp</p>
                </div>
                <div class="card-header bg-white p-1 d-flex gap-1">
                  <button
                    nz-button
                    nzSize="small"
                    class="fs-12 button button-succes btn-add"
                    (click)="openProjectSolutionDetail(false)"
                    *hasPermission="'N38,N1,N63,N27'"
                  >
                    <img
                      src="assets/icon/action_add_item_16.png"
                      alt="Thêm mới "
                    />
                    Thêm
                  </button>
                  <button
                    class="fs-12 btn-edit"
                    nz-button
                    nzType="default"
                    nzSize="small"
                    (click)="openProjectSolutionDetail(true)"
                    *hasPermission="'N38,N1,N63,N27'"
                  >
                    <img src="assets/icon/action_edit_item_16.png" alt="Sửa" />
                    Sửa
                  </button>

                  <ng-container *hasPermission="'N13,N1,N65'">
                    <button
                      class="fs-12"
                      nz-button
                      nzType="default"
                      nzSize="small"
                      nz-dropdown
                      [nzDropdownMenu]="menuDuyetPo"
              
                    >
                      <img src="assets/icon/action_confirm_tbp_16.png" alt="yêu cầu " /> Yêu cầu
                      <i nz-icon nzType="down"></i>
                    </button>
                  </ng-container>
                  <nz-dropdown-menu #menuDuyetPo="nzDropdownMenu">
                    <ul nz-menu>
                      <li nz-menu-item (click)="ApprovePO(true)">
                        <img src="assets/icon/action_approved_16.png" />
                        <span class="ms-1">Duyệt Po</span>
                      </li>
                      <li nz-menu-item (click)="ApprovePO(false)">
                        <img src="assets/icon/action_unapproved_16.png" />
                        <span class="ms-1">Hủy duyệt Po</span>
                      </li>
                     
                    </ul>
                  </nz-dropdown-menu>
                </div>
                <div class="card-body p-0 flex-grow-1 overflow-hidden" style="min-height: 0;">
                  <div #tb_solution style="width: 100%; height: 100%; min-height: 0;"></div>
                </div>
              </div>
            </nz-splitter-panel>
  
            <!-- Bảng 2: Phiên bản giải pháp -->
            <nz-splitter-panel nzDefaultSize="33.33%">
              <div class="card h-100 border-0 rounded-0 d-flex flex-column">
                <div class="card-header bg-white p-1">
                  <p class="m-0">Phiên bản giải pháp</p>
                </div>
                <div class="card-header bg-white p-1 d-flex gap-1">
                  <button
                    nz-button
                    nzSize="small"
                    class="fs-12 button button-succes btn-add"
                    (click)="openProjectSolutionVersionDetail(1, false)" *hasPermission="'N1,N27,N38,N62,N28'"
                  >
                    <img
                      src="assets/icon/action_add_item_16.png"
                      alt="Thêm mới "
                    />
                    Thêm
                  </button>
                  <button
                    class="fs-12 btn-edit"
                    nz-button
                    nzType="default"
                    nzSize="small"
                    (click)="openProjectSolutionVersionDetail(1, true)" *hasPermission="'N38,N1, N62,N28,N27'"
                  >
                    <img src="assets/icon/action_edit_item_16.png" alt="Sửa" />
                    Sửa
                  </button>
                  <button
                    class="fs-12 btn-delete"
                    nz-button
                    nzType="default"
                    nzSize="small"
                    nzDanger
                    (click)="deleteProjectSolutionVersion(1)" *hasPermission="'N38,N1, N62,N28,N27'"
                  >
                    <img src="assets/icon/action_delete_item_16.png" alt="Xóa " />
                    Xóa
                  </button>
                  <!-- <button
                  class="fs-12"
                  nz-button
                  nzType="default"
                  nzSize="small"
                  (click)="onExportExcelSolutionVersion()"
                >
                  <img src="assets/icon/action_export_excel_16.png" /> Xuất Excel
                </button> -->
                </div>
                <div class="card-body p-0 flex-grow-1 overflow-hidden" style="min-height: 0;">
                  <div
                    #tb_projectPartListVersion
                    style="width: 100%; height: 100%; min-height: 0;"
                  ></div>
                </div>
              </div>
            </nz-splitter-panel>
  
            <!-- Bảng 3: Phiên bản PO -->
            <nz-splitter-panel nzDefaultSize="33.33%">
              <div class="card h-100 border-0 rounded-0 d-flex flex-column">
                <div class="card-header bg-white p-1 d-flex gap-1">
                  <p class="m-0">Phiên bản PO</p>
                </div>
                <div class="card-header bg-white p-1 d-flex gap-1">
                  <button
                    nz-button
                    nzSize="small"
                    class="fs-12 button button-succes btn-add"
                    (click)="openProjectSolutionVersionDetail(2, false)"
                    *hasPermission="'N38,N1, N62,N28,N27'"
                  >
                    <img
                      src="assets/icon/action_add_item_16.png"
                      alt="Thêm mới "
                    />
                    Thêm
                  </button>
                  <button
                    class="fs-12 btn-edit"
                    nz-button
                    nzType="default"
                    nzSize="small"
                    (click)="openProjectSolutionVersionDetail(2, true)"
                    *hasPermission="'N38,N1, N62,N28,N27'"
                  >
                    <img src="assets/icon/action_edit_item_16.png" alt="Sửa" />
                    Sửa
                  </button>
                  <button
                    class="fs-12 btn-delete"
                    nz-button
                    nzType="default"
                    nzSize="small"
                    nzDanger
                    (click)="deleteProjectSolutionVersion(2)"
                    *hasPermission="'N38,N1, N62,N28,N27'"
                  >
                    <img src="assets/icon/action_delete_item_16.png" alt="Xóa " />
                    Xóa
                  </button>
                  <!-- <button
                    class="fs-12"
                    nz-button
                    nzType="default"
                    nzSize="small"
                    (click)="onExportExcelPOVersion()"
                  >
                    <img src="assets/icon/action_export_excel_16.png" /> Xuất Excel
                  </button> -->
                </div>
                <div class="card-body p-0 flex-grow-1 overflow-hidden" style="min-height: 0;">
                  <div #tb_projectPartListVersionPO style="width: 100%; height: 100%; min-height: 0;"></div>
                </div>
              </div>
            </nz-splitter-panel>
          </nz-splitter>
        </nz-splitter-panel>
  
        <!-- Phần phải: Bảng nhân công -->
        <nz-splitter-panel nzDefaultSize="75%" nzMin="50%" nzMax="80%">
          <div class="card h-100 border-0 rounded-0 d-flex flex-column">
            <div class="card-header bg-white p-1 d-flex gap-1">
              <p class="m-0">Danh mục vật tư dự án {{ projectCodex }} -{{ type ==1 ? 'Giải pháp' : 'PO' }} -{{ projectTypeName }} -{{ CodeName }}</p>
            </div>
  
            <div class="card-header bg-white p-1 d-flex gap-1">
              <button
                nz-button
                nzSize="small"
                class="fs-12 button button-succes btn-add"
                (click)="openProjectWorkerDetail(false)"
              >
                <img src="assets/icon/action_add_item_16.png" alt="Thêm mới " />
                Thêm
              </button>
              <button
                class="fs-12 btn-edit"
                nz-button
                nzType="default"
                nzSize="small"
                (click)="openProjectWorkerDetail(true)"
              >
                <img src="assets/icon/action_edit_item_16.png" alt="Sửa" /> Sửa
              </button>
              <button
                class="fs-12 btn-delete"
                nz-button
                nzType="default"
                nzSize="small"
                nzDanger
                click
                (click)="deleteProjectWorker()"
              >
                <img src="assets/icon/action_delete_item_16.png" alt="Xóa " /> Xóa
              </button>
              <ng-container *hasPermission="''">
                <button
                  class="fs-12"
                  nz-button
                  nzType="default"
                  nzSize="small"
                  nz-dropdown
                  [nzDropdownMenu]="menuYeuCau"
          
                >
                  <img src="assets/icon/action_confirm_tbp_16.png" alt="yêu cầu " /> Yêu cầu
                  <i nz-icon nzType="down"></i>
                </button>
              </ng-container>
              <nz-dropdown-menu #menuYeuCau="nzDropdownMenu">
                <ul nz-menu>
                  <li nz-menu-item (click)="requestPriceQuote()">
                    <img src="assets/icon/action_approved_16.png" />
                    <span class="ms-1">Yêu cầu báo giá</span>
                  </li>
                  <li nz-menu-item (click)="cancelPriceRequest()">
                    <img src="assets/icon/action_unapproved_16.png" />
                    <span class="ms-1">Hủy yêu cầu báo giá</span>
                  </li>
                  <li nz-menu-item (click)="requestPurchase()">
                    <img src="assets/icon/action_approved_16.png" />
                    <span class="ms-1">Yêu cầu mua hàng</span>
                  </li>
                  <li nz-menu-item (click)="cancelPurchaseRequest()">
                    <img src="assets/icon/action_unapproved_16.png" />
                    <span class="ms-1">Hủy yêu cầu mua hàng</span>
                  </li>
                </ul>
              </nz-dropdown-menu>
              <ng-container *hasPermission="'N38,N1,N64'">
                <button
                  class="fs-12"
                  nz-button
                  nzType="default"
                  nzSize="small"
                  nz-dropdown
                  [nzDropdownMenu]="menuTBPduyetmoi"
          
                >
                  <img src="assets/icon/action_confirm_tbp_16.png" alt="TBP duyệt" /> TBP duyệt
                  <i nz-icon nzType="down"></i>
                </button>
              </ng-container>
              <nz-dropdown-menu #menuTBPduyetmoi="nzDropdownMenu">
                <ul nz-menu>
                  <li nz-menu-item (click)="approveNewCode(true)">
                    <img src="assets/icon/action_approved_16.png" />
                    <span class="ms-1">TBP duyệt mới</span>
                  </li>
                  <li nz-menu-item (click)="approveNewCode(false)">
                    <img src="assets/icon/action_unapproved_16.png" />
                    <span class="ms-1">TBP hủy duyệt mới</span>
                  </li>
                </ul>
              </nz-dropdown-menu>
              <ng-container  *hasPermission="'N38,N1,N64'">
                <button
                  class="fs-12"
                  nz-button
                  nzType="default"
                  nzSize="small"
                  nz-dropdown
                  [nzDropdownMenu]="menuTBP"
                  *ngIf="type == 2"
                >
                  <img src="assets/icon/action_confirm_tbp_16.png" alt="TBP duyệt" /> TBP xác nhận
                  <i nz-icon nzType="down"></i>
                </button>
              </ng-container>
              <nz-dropdown-menu #menuTBP="nzDropdownMenu">
                <ul nz-menu>
                  <li nz-menu-item (click)="updateApprove(1)">
                    <img src="assets/icon/action_approved_16.png" />
                    <span class="ms-1">TBP duyệt</span>
                  </li>
                  <li nz-menu-item (click)="updateApprove(2)">
                    <img src="assets/icon/action_unapproved_16.png" />
                    <span class="ms-1">TBP hủy duyệt</span>
                  </li>
                </ul>
              </nz-dropdown-menu>
              <button
            class="fs-12"
            nz-button
            nzType="default"
            nzSize="small"
            (click)="openImportExcelProjectPartList()"
          >
            <img src="assets/icon/action_import_excel_16.png" /> Nhập Excel
          </button>
  
          <button
            class="fs-12"
            nz-button
            nzType="default"
            nzSize="small"
            (click)="onExportExcel()"
          >
              <img src="assets/icon/action_export_excel_16.png" /> Xuất Excel
          </button>
            </div>
  
            <div class="card-header bg-white p-1 d-flex gap-1">
              <div
                style="min-width: 400px"
                class="d-flex gap-1 ms-auto align-items-center"
              >
                <label class="fs-12 mb-0">Trạng thái TBP</label>
                <nz-select
                  name="IsLateActual"
                 
                  nzShowSearch
                  nzAllowClear
                  nzPlaceHolder="Chọn trạng thái"
                  nzSize="small"
                  [ngModel]="isApprovedTBP"
                  (ngModelChange)="isApprovedTBP = $event; searchDataProjectWorker()"
                >
                  <nz-option [nzValue]="-1" nzLabel="--Tất cả--"></nz-option>
                  <nz-option [nzValue]="0" nzLabel="Chưa duyệt"></nz-option>
                  <nz-option [nzValue]="1" nzLabel="Đã duyệt"></nz-option>
                </nz-select>
  
                <label class="fs-12 mb-0">Trạng thái Y/c mua</label>
                <nz-select
                  name="IsApprovedPurchase"
                 
                  nzShowSearch
                  nzAllowClear
                  nzPlaceHolder="Chọn trạng thái"
                  nzSize="small"
                  [ngModel]="isApprovedPurchase"
                  (ngModelChange)="isApprovedPurchase = $event; loadDataProjectPartList()"
                >
                  <nz-option [nzValue]="-1" nzLabel="--Tất cả--"></nz-option>
                  <nz-option [nzValue]="0" nzLabel="Chưa Y/c mua"></nz-option>
                  <nz-option [nzValue]="1" nzLabel="Đã yêu cầu mua"></nz-option>
                </nz-select>
                <label class="fs-12 mb-0">Trạng thái</label>
                <nz-select
                  name="IsDeleted"
                 
                  nzShowSearch
                  nzAllowClear
                  nzPlaceHolder="Chọn trạng thái"
                  nzSize="small"
                  [ngModel]="isDeleted"
                  (ngModelChange)="isDeleted = $event; loadDataProjectPartList()"
                >
                  <nz-option [nzValue]="-1" nzLabel="--Tất cả--"></nz-option>
                  <nz-option [nzValue]="0" nzLabel="Chưa xóa"></nz-option>
                  <nz-option [nzValue]="1" nzLabel="Đã xóa"></nz-option>
                </nz-select>
                <input
                  nz-input
                  nzSize="small"
                  placeholder="Nhập từ khóa"
                  style="width: 150px"
                  [ngModel]="keyword"
                  (ngModelChange)="keyword = $event; loadDataProjectPartList()"
                />
                <!-- <button
                  type="submit"
                  nz-button
                  nzType="primary"
                  nzSize="small"
                  (click)="searchDataProjectWorker()"
                  (keyup.enter)="searchDataProjectWorker()"
                >
                  Tìm kiếm
                </button> -->
              </div>
            </div>
  
            <div class="card-body p-0 flex-grow-1 overflow-hidden" style="min-height: 0;">
              <div #tb_projectWorker style="width: 100%; height: 100%; min-height: 0;"></div>
            </div>
          </div>
        </nz-splitter-panel>
      </nz-splitter>
    </div>
    <!-- Modal Footer -->
    <div class="modal-footer bg-whitesmoke p-1" style="flex-shrink: 0">
      <button nz-button nzType="default" nzDanger (click)="activeModal.dismiss()">
        Đóng
      </button>
    </div>
  </div>

  <!-- Template cho modal yêu cầu báo giá -->
  <ng-template #priceRequestModalContent>
    <div style="padding: 20px;">
      <p class="mb-3">
        <strong>Chọn deadline báo giá cho vật tư đã chọn</strong>
      </p>
      <div class="mb-3">
        <label class="d-block mb-2">
          <span class="text-danger">*</span> Deadline báo giá:
        </label>
        <nz-date-picker
          [(ngModel)]="deadlinePriceRequest"
          nzFormat="dd/MM/yyyy"
          nzPlaceHolder="Chọn ngày deadline"
          [nzDisabledDate]="disabledDate"
          style="width: 100%;"
        ></nz-date-picker>
      </div>
      <div class="text-muted" style="font-size: 12px;">
        <i nz-icon nzType="info-circle" nzTheme="outline"></i>
        <span class="ms-1">
          <strong>Lưu ý:</strong><br/>
          - Deadline phải lớn hơn hôm nay ít nhất 2 ngày làm việc<br/>
          - Nếu yêu cầu sau 15h: deadline sẽ bắt đầu tính từ ngày hôm sau<br/>
          - Chỉ chọn được các ngày làm việc (Thứ 2 - Thứ 6)
        </span>
      </div>
    </div>
  </ng-template>

  <!-- Modal chọn deadline mua hàng -->
  <ng-template #purchaseRequestModalContent>
    <div style="padding: 20px;">
      <p class="mb-3">
        <strong>Chọn deadline hàng về cho vật tư đã chọn</strong>
      </p>
      <div class="mb-3">
        <label class="d-block mb-2">
          <span class="text-danger">*</span> Deadline hàng về:
        </label>
        <nz-date-picker
          [(ngModel)]="deadlinePurchaseRequest"
          nzFormat="dd/MM/yyyy"
          nzPlaceHolder="Chọn ngày deadline"
          [nzDisabledDate]="disabledDatePurchase"
          style="width: 100%;"
        ></nz-date-picker>
      </div>
      <div class="text-muted" style="font-size: 12px;">
        <i nz-icon nzType="info-circle" nzTheme="outline"></i>
        <span class="ms-1">
          <strong>Lưu ý:</strong><br/>
          - Deadline phải lớn hơn hôm nay ít nhất 2 ngày làm việc<br/>
          - Nếu yêu cầu sau 15h: deadline sẽ bắt đầu tính từ ngày hôm sau<br/>
          - Chỉ chọn được các ngày làm việc (Thứ 2 - Thứ 6)
        </span>
      </div>
    </div>
  </ng-template>
  