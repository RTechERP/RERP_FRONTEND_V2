<div class="modal-dialog-scrollable">
  <div class="modal-header bg-primary text-uppercase py-2">
    <h6 class="modal-title text-white">Chi tiết vật tư</h6>
    <button
      type="button"
      class="btn-close"
      (click)="closeModal()"
      aria-label="Close"
    ></button>
  </div>

  <div class="modal-body" style="max-height: 80vh !important; overflow-y: auto;">
    <nz-tabset class="p-0" (nzSelectedIndexChange)="onChangeTab($event)" style="height: 70vh; display: flex; flex-direction: column;">
      <!-- Tab 1: Thông tin chung -->
      <nz-tab nzTitle="Thông tin chung">
        <div style="height: calc(70vh - 50px);">
          <form nz-form [formGroup]="formGroup" nzLayout="vertical" class="g-3 needs-validation was-validated">
          <!-- Hàng 1: Dự án + Phiên bản + TT -->
          <div class="row">
            <div class="col-md-4 ">
              <nz-form-item>
                <nz-form-label class="fs-12">
                  Dự án
                  <span class="text-danger ps-1 me-1">*</span>
                </nz-form-label>
                <nz-form-control
                  [nzErrorTip]="
                    formGroup.get('projectId')?.invalid &&
                    (formGroup.get('projectId')?.dirty || formGroup.get('projectId')?.touched)
                      ? 'Vui lòng chọn dự án!'
                      : undefined
                  "
                >
                  <nz-select 
                    formControlName="projectId" 
                    class="fs-12 w-100" 
                    nzShowSearch 
                    nzAllowClear
                    nzPlaceHolder="Chọn dự án">
                    @for (item of projects; track $index) {
                      <nz-option 
                        [nzValue]="item.ID" 
                        [nzLabel]="item.ProjectCode + ' - ' + item.ProjectName">
                      </nz-option>
                    }
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>
            <div class="col-md-4 ">
              <nz-form-item>
                <nz-form-label class="fs-12">
                  Phiên bản
                  <span class="text-danger ps-1 me-1">*</span>
                </nz-form-label>
                <nz-form-control
                  [nzErrorTip]="
                    formGroup.get('versionId')?.invalid &&
                    (formGroup.get('versionId')?.dirty || formGroup.get('versionId')?.touched)
                      ? 'Vui lòng chọn phiên bản!'
                      : undefined
                  "
                >
                  <nz-select 
                    formControlName="versionId" 
                    class="fs-12 w-100" 
                    nzShowSearch 
                    nzAllowClear
                    nzPlaceHolder="Chọn phiên bản">
                    @for (item of versions; track $index) {
                      <nz-option 
                        [nzValue]="item.ID" 
                        [nzLabel]="item.Code + ' - ' + (item.StatusVersion==1?'Giải pháp':'PO')">
                      </nz-option>
                    }
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>
            <div class="col-md-4 ">
              <nz-form-item>
                <nz-form-label class="fs-12">
                  TT
                  <span class="text-danger ps-1 me-1">*</span>
                </nz-form-label>
                <nz-form-control
                  [nzErrorTip]="getFieldError('tt')"
                >
                  <input 
                    formControlName="tt" 
                    nz-input 
                    class="fs-12" 
                    placeholder="Nhập TT (VD: 1, 1.1)" />
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>

          <!-- Hàng 2: Mã thiết bị + Mã đặc biệt + Đã xóa -->
          <div class="row">
            <div class="col-md-4 ">
              <nz-form-item>
                <nz-form-label class="fs-12">
                  Mã thiết bị
                  <span class="text-danger ps-1 me-1">*</span>
                </nz-form-label>
                <nz-form-control
                  [nzErrorTip]="
                    formGroup.get('productCode')?.invalid &&
                    (formGroup.get('productCode')?.dirty || formGroup.get('productCode')?.touched)
                      ? 'Vui lòng nhập mã thiết bị!'
                      : undefined
                  "
                >
                  <input 
                    formControlName="productCode" 
                    nz-input 
                    class="fs-12" 
                    placeholder="Nhập mã thiết bị" />
                </nz-form-control>
              </nz-form-item>
            </div>
            <div class="col-md-4 ">
              <nz-form-item>
                <nz-form-label class="fs-12">Mã đặc biệt</nz-form-label>
                <nz-form-control>
                  <div class="d-flex gap-1">
                    <input 
                      formControlName="specialCode" 
                      nz-input 
                      class="fs-12 flex-grow-1" 
                      placeholder="Nhập mã đặc biệt"
                      (keyup.enter)="onSearchSpecialCode($event)" />
                    <button
                      *ngIf="currentPartListId > 0"
                      type="button"
                      nz-button
                      nzType="primary"
                      nzSize="default"
                      (click)="onSearchSpecialCode($event)"
                    >
                      <i nz-icon nzType="check"></i>
                      Cập nhật
                    </button>
                  </div>
                </nz-form-control>
              </nz-form-item>
            </div>
            <div class="col-md-4  align-items-center h-auto">
              <nz-form-item>
                <nz-form-label
                  class="fs-12 d-flex align-items-center"
                  [style.visibility]="'hidden'"
                >
                  Đã xóa
                </nz-form-label>
                <nz-form-control>
                  <label
                    class="mb-0 fs-12 justify-content"
                    nz-checkbox
                    formControlName="isDeleted"
                  >Đã xóa</label>
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>

          <!-- Hàng 3: Tên thiết bị + Hãng SX + Đơn vị -->
          <div class="row">
            <div class="col-md-4 ">
              <nz-form-item>
                <nz-form-label class="fs-12">Tên thiết bị</nz-form-label>
                <nz-form-control>
                  <input 
                    formControlName="productName" 
                    nz-input 
                    class="fs-12" 
                    placeholder="Nhập tên thiết bị"
                    [nzAutocomplete]="productNameAuto" />
                  <nz-autocomplete 
                    #productNameAuto 
                    [nzDataSource]="productNameOptions"
                    (selectionChange)="formGroup.patchValue({ productName: $event.nzValue })">
                  </nz-autocomplete>
                </nz-form-control>
              </nz-form-item>
            </div>
            <div class="col-md-4 ">
              <nz-form-item>
                <nz-form-label class="fs-12">Hãng SX <span class="text-danger ps-1 me-1">*</span></nz-form-label>
                <nz-form-control
                  [nzErrorTip]="getFieldError('maker')"
                >
                  <input 
                    formControlName="maker" 
                    nz-input 
                    class="fs-12" 
                    placeholder="Nhập hãng sản xuất"
                    [nzAutocomplete]="makerAuto" />
                  <nz-autocomplete 
                    #makerAuto 
                    [nzDataSource]="makerOptions"
                    (selectionChange)="formGroup.patchValue({ maker: $event.nzValue })">
                  </nz-autocomplete>
                </nz-form-control>
              </nz-form-item>
            </div>
            <div class="col-md-4 ">
              <nz-form-item>
                <nz-form-label class="fs-12">Đơn vị <span class="text-danger ps-1 me-1">*</span></nz-form-label>
                <nz-form-control
                  [nzErrorTip]="getFieldError('unit')"
                >
                  <nz-select 
                  formControlName="unit" 
                  class="fs-12 w-100" 
                  nzShowSearch 
                  nzAllowClear
                  nzPlaceHolder="Chọn đơn vị">
                  @for (item of unitData; track $index) {
                    <nz-option [nzValue]="item.UnitName" [nzLabel]="item.UnitName"></nz-option>
                  }
                </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>

          <!-- Hàng 4: Thông tin kỹ thuật -->
          <div class="row">
            <div class="col-md-12 ">
              <nz-form-item>
                <nz-form-label class="fs-12">Thông tin kỹ thuật</nz-form-label>
                <nz-form-control>
                  <textarea 
                    formControlName="technicalInfo" 
                    rows="3" 
                    nz-input 
                    class="fs-12" 
                    placeholder="Nhập thông tin kỹ thuật"></textarea>
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>

          <!-- Hàng 5: Số lượng/1 máy + Số lượng tổng + NV phụ trách -->
          <div class="row">
            <div class="col-md-4 ">
              <nz-form-item>
                <nz-form-label class="fs-12">Số lượng/1 máy </nz-form-label>
                <nz-form-control
                  [nzErrorTip]="getFieldError('qtyMin')"
                >
                  <nz-input-number
                    formControlName="qtyMin"
                    class="fs-12 w-100"
                    [nzMin]="0"
                    [nzStep]="1"
                    [nzPrecision]="0"
                    placeholder="0">
                  </nz-input-number>
                </nz-form-control>
              </nz-form-item>
            </div>
            <div class="col-md-4 ">
              <nz-form-item>
                <nz-form-label class="fs-12">Số lượng tổng</nz-form-label>
                <nz-form-control
                  [nzErrorTip]="getFieldError('qtyFull')"
                >
                  <nz-input-number
                    formControlName="qtyFull"
                    class="fs-12 w-100"
                    [nzMin]="0"
                    [nzStep]="1"
                    [nzPrecision]="0"
                    placeholder="0">
                  </nz-input-number>
                </nz-form-control>
              </nz-form-item>
            </div>
            <div class="col-md-4 ">
              <nz-form-item>
                <nz-form-label class="fs-12">NV phụ trách</nz-form-label>
                <nz-form-control>
                  <nz-select 
                    formControlName="employeeId" 
                    class="fs-12 w-100" 
                    nzShowSearch 
                    nzAllowClear
                    nzPlaceHolder="Chọn nhân viên">
                    @for (parent of employees; track $index) {
                      <nz-option-group [nzLabel]="parent.label">
                        @for (child of parent.options; track $index) {
                          <nz-option 
                            nzCustomContent="true" 
                            [nzLabel]="child.item.FullName" 
                            [nzValue]="child.item.ID">
                            {{ child.item.Code + " - " + child.item.FullName }}
                          </nz-option>
                        }
                      </nz-option-group>
                    }
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>

          <!-- Hàng 6: Hàng phát sinh checkbox -->
          <div class="row">
            <div class="col-md-12  align-items-center h-auto">
              <nz-form-item>
                <!-- <nz-form-label class="fs-12 d-flex align-items-center" [style.visibility]="'hidden'">
                  Hàng phát sinh
                </nz-form-label> -->
                <nz-form-control>
                  <label
                    class="mb-0 fs-12 justify-content"
                    nz-checkbox
                    formControlName="isProblem"
                  >Hàng phát sinh</label>
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>

          <!-- Hàng 7: Lý do phát sinh -->
          <div class="row">
            <div class="col-md-12 ">
              <nz-form-item>
                <nz-form-label class="fs-12">Lý do phát sinh</nz-form-label>
                <nz-form-control>
                  <textarea 
                    formControlName="reasonProblem" 
                    rows="2" 
                    nz-input 
                    class="fs-12" 
                    placeholder="Nhập lý do phát sinh"></textarea>
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>

          <!-- Hàng 8: Ghi chú -->
          <div class="row">
            <div class="col-md-12 ">
              <nz-form-item>
                <nz-form-label class="fs-12">Ghi chú</nz-form-label>
                <nz-form-control>
                  <textarea 
                    formControlName="note" 
                    rows="3" 
                    nz-input 
                    class="fs-12" 
                    placeholder="Nhập ghi chú"></textarea>
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>
        </form>
        </div>
      </nz-tab>

      <!-- Tab 2: Thông tin báo giá - đặt mua -->
      <nz-tab nzTitle="Thông tin báo giá - đặt mua">
        <div style="height: calc(70vh - 50px); overflow-y: auto;">
          <form nz-form [formGroup]="formGroup" nzLayout="vertical" class="g-3 needs-validation was-validated">
            <!-- Fieldset: Thông tin báo giá -->
            <fieldset style="border: 1px solid #d9d9d9; border-radius: 4px; padding: 16px; margin-bottom: 20px;">
              <legend style="font-size: 14px; font-weight: 600; padding: 0 8px; width: auto; margin-bottom: 0;">Thông tin báo giá</legend>
              
              <!-- Hàng 1: Nhà cung cấp + Tên NCC + Loại tiền + Lead Time -->
              <div class="row">
                <div class="col-md-3 ">
                  <nz-form-item>
                    <nz-form-label class="fs-12">Nhà cung cấp</nz-form-label>
                    <nz-form-control>
                      <nz-select 
                        formControlName="supplierQuoteId" 
                        class="fs-12 w-100" 
                        nzShowSearch 
                        nzAllowClear
                        nzPlaceHolder="Chọn nhà cung cấp">
                        @for (item of suppliers; track $index) {
                          <nz-option [nzValue]="item.ID" [nzLabel]="item.CodeNCC"></nz-option>
                        }
                      </nz-select>
                    </nz-form-control>
                  </nz-form-item>
                </div>
                <div class="col-md-3 ">
                  <nz-form-item>
                    <nz-form-label class="fs-12">Tên NCC</nz-form-label>
                    <nz-form-control>
                      <input 
                        formControlName="ncc" 
                        nz-input 
                        class="fs-12" 
                        placeholder="Tên nhà cung cấp" 
                        readonly
                        [disabled]="true" />
                    </nz-form-control>
                  </nz-form-item>
                </div>
                <div class="col-md-3 ">
                  <nz-form-item>
                    <nz-form-label class="fs-12">Loại tiền</nz-form-label>
                    <nz-form-control>
                      <nz-select 
                        formControlName="currencyQuote" 
                        class="fs-12 w-100" 
                        nzShowSearch 
                        nzAllowClear
                        nzPlaceHolder="Chọn loại tiền">
                        @for (item of currencies; track $index) {
                          <nz-option [nzValue]="item.Code" [nzLabel]="item.Code"></nz-option>
                        }
                      </nz-select>
                    </nz-form-control>
                  </nz-form-item>
                </div>
                <div class="col-md-3 ">
                  <nz-form-item>
                    <nz-form-label class="fs-12">Lead Time</nz-form-label>
                    <nz-form-control>
                      <input 
                        formControlName="leadTimeQuote" 
                        nz-input 
                        class="fs-12" 
                        placeholder=""
                        [disabled]="true" />
                    </nz-form-control>
                  </nz-form-item>
                </div>
              </div>

              <!-- Hàng 2: Đơn giá + Thành tiền -->
              <div class="row">
                <div class="col-md-6 ">
                  <nz-form-item>
                    <nz-form-label class="fs-12">Đơn giá</nz-form-label>
                    <nz-form-control>
                      <nz-input-number
                        formControlName="unitPriceQuote"
                        class="fs-12 w-100"
                        [nzMin]="0"
                        [nzStep]="1000"
                        [nzPrecision]="0"
                        [nzFormatter]="formatCurrency"
                        [nzParser]="parseCurrency"
                        placeholder="0">
                      </nz-input-number>
                    </nz-form-control>
                  </nz-form-item>
                </div>
                <div class="col-md-6 ">
                  <nz-form-item>
                    <nz-form-label class="fs-12">Thành tiền</nz-form-label>
                    <nz-form-control>
                      <nz-input-number
                        formControlName="totalPriceQuote"
                        class="fs-12 w-100"
                        [nzMin]="0"
                        [nzStep]="1000"
                        [nzPrecision]="0"
                        [nzFormatter]="formatCurrency"
                        [nzParser]="parseCurrency"
                        placeholder="0">
                      </nz-input-number>
                    </nz-form-control>
                  </nz-form-item>
                </div>
              </div>
            </fieldset>

            <!-- Fieldset: Thông tin đặt mua -->
            <fieldset style="border: 1px solid #d9d9d9; border-radius: 4px; padding: 16px; margin-bottom: 20px;">
              <legend style="font-size: 14px; font-weight: 600; padding: 0 8px; width: auto; margin-bottom: 0;">Thông tin đặt mua</legend>
              
              <!-- Hàng 1: Mã đặt hàng + Nhà cung cấp + Tên NCC + Loại tiền -->
              <div class="row">
                <div class="col-md-3 ">
                  <nz-form-item>
                    <nz-form-label class="fs-12">Mã đặt hàng</nz-form-label>
                    <nz-form-control>
                      <input 
                        formControlName="billCodePurchase" 
                        nz-input 
                        readonly
                        class="fs-12" 
                        placeholder="Nhập mã đặt hàng"
                        [disabled]="true" />
                    </nz-form-control>
                  </nz-form-item>
                </div>
                <div class="col-md-3 ">
                  <nz-form-item>
                    <nz-form-label class="fs-12">Nhà cung cấp</nz-form-label>
                    <nz-form-control>
                      <nz-select 
                        formControlName="supplierPurchaseId" 
                        class="fs-12 w-100" 
                        nzShowSearch 
                        nzAllowClear
                        nzPlaceHolder="Chọn nhà cung cấp"
                        [nzDisabled]="true">
                        @for (item of suppliers; track $index) {
                          <nz-option [nzValue]="item.ID" [nzLabel]="item.CodeNCC"></nz-option>
                        }
                      </nz-select>
                    </nz-form-control>
                  </nz-form-item>
                </div>
                <div class="col-md-3 ">
                  <nz-form-item>
                    <nz-form-label class="fs-12">Tên NCC</nz-form-label>
                    <nz-form-control>
                      <input 
                        formControlName="nccFinal" 
                        nz-input 
                        class="fs-12" 
                        placeholder="Tên nhà cung cấp" 
                        readonly
                        [disabled]="true" />
                    </nz-form-control>
                  </nz-form-item>
                </div>
                <div class="col-md-3 ">
                  <nz-form-item>
                    <nz-form-label class="fs-12">Loại tiền</nz-form-label>
                    <nz-form-control>
                      <nz-select 
                        formControlName="currencyPurchase" 
                        class="fs-12 w-100" 
                        nzShowSearch 
                        nzAllowClear
                        nzPlaceHolder="Chọn loại tiền"
                        [nzDisabled]="true">
                        @for (item of currencies; track $index) {
                          <nz-option [nzValue]="item.Code" [nzLabel]="item.Code || item.Code"></nz-option>
                        }
                      </nz-select>
                    </nz-form-control>
                  </nz-form-item>
                </div>
              </div>

              <!-- Hàng 2: Đơn giá + Thành tiền + Lead Time -->
              <div class="row">
                <div class="col-md-4 ">
                  <nz-form-item>
                    <nz-form-label class="fs-12">Đơn giá</nz-form-label>
                    <nz-form-control>
                      <nz-input-number
                        formControlName="unitPricePurchase"
                        class="fs-12 w-100"
                        [nzMin]="0"
                        [nzStep]="1000"
                        [nzPrecision]="0"
                        [nzFormatter]="formatCurrency"
                        [nzParser]="parseCurrency"
                        [nzDisabled]="true"
                        placeholder="0">
                      </nz-input-number>
                    </nz-form-control>
                  </nz-form-item>
                </div>
                <div class="col-md-4 ">
                  <nz-form-item>
                    <nz-form-label class="fs-12">Thành tiền</nz-form-label>
                    <nz-form-control>
                      <nz-input-number
                        formControlName="totalPricePurchase"
                        class="fs-12 w-100"
                        [nzMin]="0"
                        [nzStep]="1000"
                        [nzPrecision]="0"
                        [nzFormatter]="formatCurrency"
                        [nzParser]="parseCurrency"
                        [nzDisabled]="true"
                        placeholder="0">
                      </nz-input-number>
                    </nz-form-control>
                  </nz-form-item>
                </div>
                <div class="col-md-4 ">
                  <nz-form-item>
                    <nz-form-label class="fs-12">Lead Time</nz-form-label>
                    <nz-form-control>
                      <input 
                        formControlName="leadTimePurchase" 
                        nz-input 
                        readonly
                        class="fs-12" 
                        placeholder=""
                        [disabled]="true" />
                    </nz-form-control>
                  </nz-form-item>
                </div>
              </div>

              <!-- Hàng 3: Ngày yêu cầu đặt hàng + Dự kiến hàng về -->
              <div class="row">
                <div class="col-md-6 ">
                  <nz-form-item>
                    <nz-form-label class="fs-12">Ngày yêu cầu đặt hàng</nz-form-label>
                    <nz-form-control>
                      <nz-date-picker 
                        formControlName="requestDate" 
                        class="w-100 fs-12" 
                        nzFormat="dd/MM/yyyy"
                        [nzAllowClear]="false"
                        [nzDisabled]="true"></nz-date-picker>
                    </nz-form-control>
                  </nz-form-item>
                </div>
                <div class="col-md-6 ">
                  <nz-form-item>
                    <nz-form-label class="fs-12">Dự kiến hàng về</nz-form-label>
                    <nz-form-control>
                      <nz-date-picker 
                        formControlName="expectedDateReturn" 
                        class="w-100 fs-12" 
                        nzFormat="dd/MM/yyyy"
                        [nzAllowClear]="false"
                        [nzDisabled]="true"></nz-date-picker>
                    </nz-form-control>
                  </nz-form-item>
                </div>
              </div>

              <!-- Hàng 4: Ngày bắt đầu đặt hàng + Ngày nhận hàng -->
              <div class="row">
                <div class="col-md-6 ">
                  <nz-form-item>
                    <nz-form-label class="fs-12">Ngày bắt đầu đặt hàng</nz-form-label>
                    <nz-form-control>
                      <nz-date-picker 
                        formControlName="startPurchaseDate" 
                        class="w-100 fs-12" 
                        nzFormat="dd/MM/yyyy"
                        [nzAllowClear]="false"
                        [nzDisabled]="true"></nz-date-picker>
                    </nz-form-control>
                  </nz-form-item>
                </div>
                <div class="col-md-6 ">
                  <nz-form-item>
                    <nz-form-label class="fs-12">Ngày nhận hàng</nz-form-label>
                    <nz-form-control>
                      <nz-date-picker 
                        formControlName="receiveDate" 
                        class="w-100 fs-12" 
                        nzFormat="dd/MM/yyyy"
                        [nzAllowClear]="false"
                        [nzDisabled]="true"></nz-date-picker>
                    </nz-form-control>
                  </nz-form-item>
                </div>
              </div>

              <!-- Hàng 5: Số lượng đã về + Tình trạng + Chất lượng -->
              <div class="row">
                <div class="col-md-4 ">
                  <nz-form-item>
                    <nz-form-label class="fs-12">Số lượng đã về</nz-form-label>
                    <nz-form-control>
                      <input 
                        formControlName="quantityReturn" 
                        nz-input 
                        readonly
                        type="number" 
                        class="fs-12" 
                        placeholder="0"
                        [disabled]="true" />
                    </nz-form-control>
                  </nz-form-item>
                </div>
                <div class="col-md-4 ">
                  <nz-form-item>
                    <nz-form-label class="fs-12">Tình trạng</nz-form-label>
                    <nz-form-control>
                      <nz-select 
                        formControlName="statusId" 
                        class="fs-12 w-100" 
                        nzShowSearch 
                        nzAllowClear
                        nzPlaceHolder="Chọn tình trạng"
                        [nzDisabled]="true">
                        @for (item of statuses; track $index) {
                          <nz-option [nzValue]="item.ID" [nzLabel]="item.StatusName"></nz-option>
                        }
                      </nz-select>
                    </nz-form-control>
                  </nz-form-item>
                </div>
                <div class="col-md-4 ">
                  <nz-form-item>
                    <nz-form-label class="fs-12">Chất lượng</nz-form-label>
                    <nz-form-control>
                      <input 
                        formControlName="quality" 
                        nz-input 
                        class="fs-12" 
                        placeholder="Nhập chất lượng"
                        readonly
                        [disabled]="true" />
                    </nz-form-control>
                  </nz-form-item>
                </div>
              </div>
            </fieldset>
          </form>
        </div>
      </nz-tab>
    </nz-tabset>
  </div>

  <div class="modal-footer">
    <button class="fs-12 btn" nz-button nzDanger (click)="closeModal()">
      Đóng
    </button>
    <!-- <button class="fs-12 btn" nz-button nzType="primary" (click)="saveData()" *ngIf="!isDisabled"> -->
    <button class="fs-12 btn" nz-button nzType="primary" (click)="saveData()" [disabled]="isDisabled">
      Lưu
    </button>
  </div>
</div>
