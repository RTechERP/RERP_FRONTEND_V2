<div class="modal-dialog-scrollable">
  <div class="modal-header bg-primary align-items-center ps-2">
    <h6 class="text-light text-uppercase m-0" style="padding: 0, 5rem">
      CHI TIẾT KHẢO SÁT DỰ ÁN
    </h6>
    <button type="button" class="btn-close" (click)="activeModal.dismiss()" aria-label="Close"></button>
  </div>

  <div class="modal-body pt-2 pb-0 p-2 w-100 position-relative" style="max-height: 80vh">

    <!-- THÔNG TIN DỰ ÁN -->
    <fieldset class="reset m-0 mb-2">
      <legend class="reset fs-12 p-0 mb-2">THÔNG TIN DỰ ÁN</legend>
      <form nz-form nzLayout="vertical" [formGroup]="validateForm">
        <nz-row [nzGutter]="8">
          <div nz-col [nzSpan]="8">
            <nz-form-item class="m-0">
              <label class="fs-12 p-0">Dự án <span class="text-danger fs-12">(*)</span></label>
              <nz-form-control [nzErrorTip]="
                  validateForm.get('projectId')?.invalid &&
                  (validateForm.get('projectId')?.dirty || validateForm.get('projectId')?.touched)
                    ? 'Vui lòng chọn dự án!'
                    : undefined
                ">
                <nz-select name="projectId" class="w-100" nzShowSearch nzAllowClear nzPlaceHolder="Chọn dự án"
                  formControlName="projectId">
                  @for (item of projects; track $index) {
                  <nz-option nzCustomContent="true" [nzLabel]="item.ProjectCode + ' - ' + item.ProjectName"
                    [nzValue]="item.ID">
                    {{ item.ProjectCode + " - " + item.ProjectName }}
                  </nz-option>
                  }
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="8">
            <nz-form-item class="m-0">
              <label class="fs-12 p-0">Khách hàng</label>
              <nz-form-control>
                <nz-select name="customerId" class="w-100" nzShowSearch nzAllowClear nzPlaceHolder="Chọn khách hàng"
                  [ngModelOptions]="{ standalone: true }" [(ngModel)]="customerId" nzDisabled="">
                  @for (item of customers; track $index) {
                  <nz-option nzCustomContent="true" [nzLabel]="item.CustomerName + ' - ' + item.CustomerCode"
                    [nzValue]="item.ID">
                    {{ item.CustomerCode + " - " + item.CustomerName }}
                  </nz-option>
                  }
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="8">
            <nz-form-item class="m-0">
              <label class="fs-12 p-0">End User</label>
              <nz-form-control>
                <nz-select name="endUserId" class="w-100" nzShowSearch nzAllowClear nzPlaceHolder="Chọn end user"
                  [ngModelOptions]="{ standalone: true }" [(ngModel)]="endUserId" nzDisabled="">
                  @for (item of customers; track $index) {
                  <nz-option nzCustomContent="true" [nzLabel]="item.CustomerName" [nzValue]="item.ID">
                    {{ item.CustomerCode + " - " + item.CustomerName }}
                  </nz-option>
                  }
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>
        </nz-row>

        <nz-row [nzGutter]="8" class="mt-1">
          <div nz-col [nzSpan]="6">
            <nz-form-item class="m-0">
              <label class="fs-12 p-0">Sale</label>
              <nz-form-control>
                <nz-select name="saleId" class="w-100" nzShowSearch nzAllowClear nzPlaceHolder="Chọn Sale"
                  [ngModelOptions]="{ standalone: true }" [(ngModel)]="saleId" nzDisabled="">
                  @for (parent of employees; track $index) {
                  <nz-option-group [nzLabel]="parent.label">
                    @for (child of parent.options; track $index) {
                    <nz-option nzCustomContent="true" [nzLabel]="child.item.FullName" [nzValue]="child.item.UserID">
                      {{ child.item.Code + " - " + child.item.FullName }}
                    </nz-option>
                    }
                  </nz-option-group>
                  }
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="6">
            <nz-form-item class="m-0">
              <label class="fs-12 p-0">Kỹ thuật</label>
              <nz-form-control>
                <nz-select name="technicalId" class="w-100" nzShowSearch nzAllowClear nzPlaceHolder="Chọn kỹ thuật"
                  [ngModelOptions]="{ standalone: true }" [(ngModel)]="technicalId" nzDisabled="">
                  @for (parent of employees; track $index) {
                  <nz-option-group [nzLabel]="parent.label">
                    @for (child of parent.options; track $index) {
                    <nz-option nzCustomContent="true" [nzLabel]="child.item.FullName" [nzValue]="child.item.UserID">
                      {{ child.item.Code + " - " + child.item.FullName }}
                    </nz-option>
                    }
                  </nz-option-group>
                  }
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="6">
            <nz-form-item class="m-0">
              <label class="fs-12 p-0">PM</label>
              <nz-form-control>
                <nz-select name="pmId" class="w-100" nzShowSearch nzAllowClear nzPlaceHolder="Chọn PM"
                  [ngModelOptions]="{ standalone: true }" [(ngModel)]="pmId" nzDisabled="">
                  @for (parent of employees; track $index) {
                  <nz-option-group [nzLabel]="parent.label">
                    @for (child of parent.options; track $index) {
                    <nz-option nzCustomContent="true" [nzLabel]="child.item.FullName" [nzValue]="child.item.ID">
                      {{ child.item.Code + " - " + child.item.FullName }}
                    </nz-option>
                    }
                  </nz-option-group>
                  }
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="6">
            <nz-form-item class="m-0">
              <label class="fs-12 p-0">Trạng thái</label>
              <nz-form-control>
                <nz-select name="statusId" class="w-100" nzShowSearch nzAllowClear nzPlaceHolder="Chọn trạng thái"
                  [ngModelOptions]="{ standalone: true }" [(ngModel)]="statusId" nzDisabled="">
                  @for (item of statuses; track $index) {
                  <nz-option nzCustomContent="true" [nzLabel]="item.StatusName" [nzValue]="item.ID">
                    {{ item.StatusName }}
                  </nz-option>
                  }
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>
        </nz-row>
      </form>
    </fieldset>

    <!-- THÔNG TIN KHẢO SÁT -->
    <fieldset class="reset m-0">
      <legend class="reset fs-12 p-0 mb-2">THÔNG TIN KHẢO SÁT</legend>
      <form nz-form nzLayout="vertical" [formGroup]="validateForm">

        <nz-row [nzGutter]="8">
          <div nz-col [nzSpan]="6">
            <nz-form-item class="m-0">
              <label class="fs-12 p-0">Người yêu cầu</label>
              <nz-select name="userRequestId" class="w-100" nzShowSearch nzAllowClear nzPlaceHolder="Chọn người yêu cầu"
                [ngModelOptions]="{ standalone: true }" [(ngModel)]="userRequestId" [nzDisabled]="isAdmin">
                @for (parent of employees; track $index) {
                <nz-option-group [nzLabel]="parent.label">
                  @for (child of parent.options; track $index) {
                  <nz-option nzCustomContent="true" [nzLabel]="child.item.Code + ' - ' + child.item.FullName"
                    [nzValue]="child.item.ID">
                    {{ child.item.Code + " - " + child.item.FullName }}
                  </nz-option>
                  }
                </nz-option-group>
                }
              </nz-select>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="6">
            <nz-form-item class="m-0">
              <label class="fs-12 p-0">
                Leader <span *ngIf="validateForm.get('isUrgent')?.value" class="text-danger">(*)</span>
              </label>
              <nz-form-control [nzErrorTip]="
                  validateForm.get('leaderId')?.invalid &&
                  (validateForm.get('leaderId')?.dirty || validateForm.get('leaderId')?.touched)
                    ? 'Vui lòng chọn leader!'
                    : undefined
                ">
                <nz-select name="leaderId" class="w-100" nzShowSearch nzAllowClear nzPlaceHolder="Chọn leader"
                  formControlName="leaderId">
                  @for (parent of employees; track $index) {
                  <nz-option-group [nzLabel]="parent.label">
                    @for (child of parent.options; track $index) {
                    <nz-option nzCustomContent="true" [nzLabel]="child.item.Code + ' - ' + child.item.FullName"
                      [nzValue]="child.item.ID">
                      {{ child.item.Code + " - " + child.item.FullName }}
                    </nz-option>
                    }
                  </nz-option-group>
                  }
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="6">
            <nz-form-item class="m-0">
              <label class="fs-12 p-0">Từ ngày</label>
              <input nz-input type="date" name="dateStart" class="w-100" formControlName="dateStart" />
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="6">
            <nz-form-item class="m-0">
              <label class="fs-12 p-0">Tới ngày</label>
              <input nz-input type="date" name="dateEnd" class="w-100" formControlName="dateEnd" />
            </nz-form-item>
          </div>
        </nz-row>

        <nz-row [nzGutter]="8" class="mt-1">
          <div nz-col [nzSpan]="6">
            <nz-form-item class="m-0">
              <label class="fs-12 p-0">
                Tên khách hàng <span class="text-danger">(*)</span>
              </label>
              <nz-form-control [nzErrorTip]="
                  validateForm.get('customerName')?.invalid &&
                  (validateForm.get('customerName')?.dirty || validateForm.get('customerName')?.touched)
                    ? 'Vui lòng nhập tên khách hàng!'
                    : undefined
                ">
                <input name="customerName" nz-input placeholder="Nhập tên khách hàng" formControlName="customerName" />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="6">
            <nz-form-item class="m-0">
              <label class="fs-12 p-0">
                SĐT khách hàng <span class="text-danger">(*)</span>
              </label>
              <nz-form-control [nzErrorTip]="
                  validateForm.get('customerPhoneNum')?.invalid &&
                  (validateForm.get('customerPhoneNum')?.dirty || validateForm.get('customerPhoneNum')?.touched)
                    ? (validateForm.get('customerPhoneNum')?.errors?.['required'] 
                        ? 'Vui lòng nhập sđt khách hàng!' 
                        : validateForm.get('customerPhoneNum')?.errors?.['phoneInvalid']
                        ? 'Số điện thoại không hợp lệ! Vui lòng nhập số điện thoại 10 số (bắt đầu bằng 0) hoặc định dạng +84/84'
                        : 'Số điện thoại không hợp lệ!')
                    : undefined
                ">
                <input name="customerPhoneNum" nz-input placeholder="Nhập SĐT (VD: 0912345678 hoặc +84 963 706 996)"
                  formControlName="customerPhoneNum" maxlength="20" />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="12">
            <nz-form-item class="m-0">
              <label class="fs-12 p-0">
                <label nz-checkbox formControlName="isUrgent">
                  Khảo sát gấp
                </label>
                <span *ngIf="validateForm.get('isUrgent')?.value" class="text-danger ms-2">- Lý do (*)</span>
              </label>
              <nz-form-control [nzErrorTip]="
                  validateForm.get('reasonUrgent')?.invalid &&
                  (validateForm.get('reasonUrgent')?.dirty || validateForm.get('reasonUrgent')?.touched)
                    ? 'Vui lòng nhập lý do gấp!'
                    : undefined
                ">
                <input name="reasonUrgent" nz-input placeholder="Nhập lý do gấp" formControlName="reasonUrgent" />
              </nz-form-control>
            </nz-form-item>
          </div>
        </nz-row>

        <nz-row [nzGutter]="8" class="mt-1">
          <div nz-col [nzSpan]="12">
            <nz-form-item class="m-0">
              <label class="fs-12 p-0">
                Địa chỉ <span class="text-danger">(*)</span>
              </label>
              <nz-form-control [nzErrorTip]="
                  validateForm.get('address')?.invalid &&
                  (validateForm.get('address')?.dirty || validateForm.get('address')?.touched)
                    ? 'Vui lòng nhập địa chỉ!'
                    : undefined
                ">
                <textarea name="address" rows="2" nz-input placeholder="Nhập địa chỉ" formControlName="address">
                </textarea>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="12">
            <nz-form-item class="m-0">
              <label class="fs-12 p-0">
                Mô tả dự án <span class="text-danger">(*)</span>
              </label>
              <nz-form-control [nzErrorTip]="
                  validateForm.get('descripsion')?.invalid &&
                  (validateForm.get('descripsion')?.dirty || validateForm.get('descripsion')?.touched)
                    ? 'Vui lòng nhập mô tả!'
                    : undefined
                ">
                <textarea name="descripsion" rows="2" nz-input placeholder="Nhập mô tả" formControlName="descripsion">
                </textarea>
              </nz-form-control>
            </nz-form-item>
          </div>
        </nz-row>

        <nz-row [nzGutter]="8" class="mt-1">
          <div nz-col [nzSpan]="12">
            <nz-form-item class="m-0">
              <label class="fs-12 p-0">Ghi chú</label>
              <nz-form-control>
                <textarea name="note" rows="13" nz-input placeholder="Nhập ghi chú" formControlName="note">
                </textarea>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="12">
            <nz-form-item class="m-0">
              <label class="fs-12 p-0">Tệp đính kèm
                <!-- <nz-upload
                [(nzFileList)]="fileList"
                [nzBeforeUpload]="beforeUpload"
                [nzMultiple]="true"
                [nzShowUploadList]="false">
                <button nz-button nzSize="small" class="fs-12">
                  <nz-icon nzType="upload" />
                  Chọn file
                </button>
              </nz-upload> -->
              </label>
              <nz-form-control>
                <div class="border mt-1" style="height: 60px !important; overflow-y: auto" #tb_projectSurveyFile></div>
              </nz-form-control>
            </nz-form-item>
          </div>
        </nz-row>
      </form>

    </fieldset>
    <nz-row [nzGutter]="8" class="mt-2">
      <div nz-col [nzSpan]="24">
        <nz-form-item class="m-0">
          <div class="border" style="height: 40px" #tb_projectSurveyDetail></div>
        </nz-form-item>
      </div>
    </nz-row>
  </div>

  <div class="modal-footer bg-whitesmoke br p-1 d-flex align-items-center">
    <div class="d-flex align-items-center flex-wrap gap-1">
      <button nz-button nzType="default" nzDanger (click)="activeModal.dismiss()">
        Đóng
      </button>
      <button nz-button nzType="primary" *ngIf="canEdit && isDisSave" (click)="save()">
        Lưu
      </button>
    </div>
  </div>
</div>