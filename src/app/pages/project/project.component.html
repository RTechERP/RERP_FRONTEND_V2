<ng-container class="w-100">
    <div class="card border-0 rounded-0 h-100">
        <div class="card-header bg-white p-1 d-flex align-items-center justify-content-between" style="overflow-x: auto;">
            <!-- Bên trái: Các nút hành động -->
            <div class="d-flex gap-1">
                <button nz-button nzType="default" nzSize="small"
                        (click)="toggleSearchPanel(); $event.stopPropagation()"
                        (mousedown)="$event.stopPropagation()"
                        (touchstart)="$event.stopPropagation()"
                        (touchend)="$event.stopPropagation()"
                        class="sticky-toggle-btn"
                        [attr.aria-label]="shouldShowSearchBar ? 'Ẩn tìm kiếm' : 'Hiện tìm kiếm'"
                        [attr.aria-expanded]="shouldShowSearchBar"
                        type="button">
                    <nz-icon [nzType]="shouldShowSearchBar ? 'up' : 'down'" />
                </button>
                        <button nz-button nzSize="small" class="fs-12 button button-succes btn-add"
                            (click)="updateProject(0)" *hasPermission="'N1,N13,N27'">
                            <img src="assets/icon/action_add_item_16.png" alt="Thêm mới " /> Thêm
                        </button>


                        <button class="fs-12 btn-edit" nz-button nzType="default" nzSize="small" nzD
                            (click)="updateProject(1)"  *hasPermission="'N1,N13,N27'">
                            <img src="assets/icon/action_edit_item_16.png" alt="Sửa">Sửa
                        </button>
                        <button class="fs-12 btn-delete" nz-button nzType="default" nzSize="small" nzDanger
                            (click)="deletedProjects()"  *hasPermission="'N1,N13,N27'">
                            <img src="assets/icon/action_delete_item_16.png" alt="Xóa " />Xóa
                        </button>
                        <button nz-button nzType="default" nzSize="small" (click)="openFolder()">
                            <img src="assets/icon/tree_folder_16.png" alt="Thêm mới " /> Cây thư mục
                        </button>
                        <!-- <button class="fs-12" nz-button nzType="default" nzSize="small" (click)="openProjectWorkerSynthetic()">
                            <img src="assets/icon/summary_assignments_16.png" alt="Tổng hợp nhân công" class="me-1" /> Tổng hợp nhân công
                        </button> -->
                        <button class="fs-12" nz-button nzType="default" nzSize="small"
                            (click)="openProjectWorkReportModal()">
                            <img src="assets/icon/list_project_report_16.png" alt="Danh sách báo cáo công việc"
                                class="me-1" /> Ds báo cáo công việc
                        </button>
                        <button class="fs-12" nz-button nzType="default" nzSize="small" (click)="openWorkItemModal()">
                            <img src="assets/icon/work_item_16.png" alt="Hạng mục công việc" class="me-1" /> Hạng mục
                            công việc
                        </button>
                        <button class="fs-12" nz-button nzType="default" nzSize="small"
                            (click)="openProjectWorkerModal()">
                            <img src="assets/icon/project_woker_16.png" alt="Nhân công dự án" class="me-1" /> Nhân công
                            dự án
                        </button>
                        <button class="fs-12" nz-button nzType="default" nzSize="small"
                            (click)="openProjectPartListModal()">
                            <img src="assets/icon/partlist_16.png" alt="Danh mục vật tư" class="me-1" /> Danh mục vật tư
                        </button>
                    </div>
                    
                    <!-- Bên phải: Tìm kiếm -->
                    <div class="d-flex gap-1 align-items-center">
                        <input
                            nz-input
                            nzSize="small"
                            nzAllowClear
                            placeholder="Nhập từ khóa"
                            style="width: 250px"
                            [(ngModel)]="keyword"
                            (keyup.enter)="searchProjects()"
                        />
                        <button nz-button nzType="default" nzSize="small" (click)="searchProjects()" class="btn">
                            <nz-icon nzType="search" />
                        </button>
                    </div>
        </div>

        <!-- Backdrop overlay cho mobile -->
        <div class="filter-backdrop" 
             *ngIf="shouldShowSearchBar" 
             (click)="toggleSearchPanel()"
             [class.mobile-only]="true">
        </div>

        <!-- Filter bar - hiển thị dạng hàng ngang trên desktop, modal trên mobile -->
        <div class="filter-bar bg-light border-bottom p-2" 
             *ngIf="shouldShowSearchBar"
             [class.mobile-modal]="true">
            <form nz-form class="mobile-filter-form">
                <nz-row [nzGutter]="[8, 8]" nzAlign="bottom">
                    <!-- Từ ngày -->
                    <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="4" [nzXl]="3">
                        <nz-form-item class="mb-0">
                            <nz-form-label class="fs-12" style="font-size: 12px;">Từ ngày</nz-form-label>
                            <nz-form-control>
                                <nz-date-picker name="dateStart" class="w-100" nzFormat="dd/MM/yyyy"
                                    [(ngModel)]="dateStart" nzSize="small" nzAllowClear="false"
                                    (ngModelChange)="getDay()"></nz-date-picker>
                            </nz-form-control>
                        </nz-form-item>
                    </nz-col>

                    <!-- Đến ngày -->
                    <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="4" [nzXl]="3">
                        <nz-form-item class="mb-0">
                            <nz-form-label class="fs-12" style="font-size: 12px;">Đến ngày</nz-form-label>
                            <nz-form-control>
                                <nz-date-picker name="dateEnd" class="w-100" nzFormat="dd/MM/yyyy" [(ngModel)]="dateEnd"
                                    nzSize="small" nzAllowClear="false"></nz-date-picker>
                            </nz-form-control>
                        </nz-form-item>
                    </nz-col>

                    <!-- Sale -->
                    <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="5" [nzXl]="4">
                        <nz-form-item class="mb-0">
                            <nz-form-label class="fs-12" style="font-size: 12px;">Sale</nz-form-label>
                            <nz-form-control>
                                <nz-select name="userId" class="w-100" nzShowSearch nzAllowClear
                                    nzPlaceHolder="Chọn Sale" nzSize="small" [(ngModel)]="userId">
                                    @for (parent of users; track $index) {
                                    <nz-option-group [nzLabel]="parent.label">
                                        @for (child of parent.options; track $index) {
                                        <nz-option nzCustomContent="true"
                                         [nzLabel]="child.item?.Code + ' - ' + child.item?.FullName"
                                            [nzValue]="child.item.ID">
                                            {{ child.item.Code + " - " + child.item.FullName }}
                                        </nz-option>
                                        }
                                    </nz-option-group>
                                    }
                                </nz-select>
                            </nz-form-control>
                        </nz-form-item>
                    </nz-col>

                    <!-- PM -->
                    <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="5" [nzXl]="4">
                        <nz-form-item class="mb-0">
                            <nz-form-label class="fs-12" style="font-size: 12px;">PM</nz-form-label>
                            <nz-form-control>
                                <nz-select name="pmId" class="w-100" nzShowSearch nzAllowClear nzPlaceHolder="Chọn PM"
                                    nzSize="small" [(ngModel)]="pmId">
                                    @for (parent of pms; track $index) {
                                    <nz-option-group [nzLabel]="parent.label">
                                        @for (child of parent.options; track $index) {
                                        <nz-option nzCustomContent="true" [nzLabel]="child.item?.Code + ' - ' + child.item?.FullName"
                                            [nzValue]="child.item.EmployeeID">
                                            {{ child.item.Code + " - " + child.item.FullName }}
                                        </nz-option>
                                        }
                                    </nz-option-group>
                                    }
                                </nz-select>
                            </nz-form-control>
                        </nz-form-item>
                    </nz-col>

                    <!-- Kỹ thuật -->
                    <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="5" [nzXl]="4">
                        <nz-form-item class="mb-0">
                            <nz-form-label class="fs-12" style="font-size: 12px;">Kỹ thuật</nz-form-label>
                            <nz-form-control>
                                <nz-select name="technicalId" class="w-100" nzShowSearch nzAllowClear
                                    nzPlaceHolder="Chọn kỹ thuật thực hiện" nzSize="small" [(ngModel)]="technicalId">
                                    @for (parent of users; track $index) {
                                    <nz-option-group [nzLabel]="parent.label">
                                        @for (child of parent.options; track $index) {
                                        <nz-option nzCustomContent="true" [nzLabel]="child.item?.Code + ' - ' + child.item?.FullName"
                                            [nzValue]="child.item.ID">
                                            {{ child.item.Code + " - " + child.item.FullName }}
                                        </nz-option>
                                        }
                                    </nz-option-group>
                                    }
                                </nz-select>
                            </nz-form-control>
                        </nz-form-item>
                    </nz-col>

                    <!-- Lĩnh vực dự án -->
                    <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="5" [nzXl]="4">
                        <nz-form-item class="mb-0">
                            <nz-form-label class="fs-12" style="font-size: 12px;">Lĩnh vực dự án</nz-form-label>
                            <nz-form-control>
                                <nz-select name="businessFieldId" class="w-100" nzShowSearch nzAllowClear
                                    nzPlaceHolder="Chọn lĩnh vực dự án" nzSize="small" [(ngModel)]="businessFieldId">
                                    @for (item of businessFields; track $index) {
                                    <nz-option nzCustomContent="true" [nzLabel]="item.Code + ' - ' + item.Name"
                                        [nzValue]="item.ID">
                                        {{ item.Code + " - " + item.Name }}
                                    </nz-option>
                                    }
                                </nz-select>
                            </nz-form-control>
                        </nz-form-item>
                    </nz-col>

                    <!-- Khách hàng -->
                    <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="5" [nzXl]="4">
                        <nz-form-item class="mb-0">
                            <nz-form-label class="fs-12" style="font-size: 12px;">Khách hàng</nz-form-label>
                            <nz-form-control>
                                <nz-select name="customerId" class="w-100" nzShowSearch nzAllowClear
                                    nzPlaceHolder="Chọn khách hàng" nzSize="small" [(ngModel)]="customerId">
                                    @for (item of customers; track $index) {
                                    <nz-option nzCustomContent="true" [nzLabel]="item.CustomerCode + ' - ' + item.CustomerName"
                                        [nzValue]="item.ID">
                                        {{ item.CustomerCode + " - " + item.CustomerName }}
                                    </nz-option>
                                    }
                                </nz-select>
                            </nz-form-control>
                        </nz-form-item>
                    </nz-col>

                    <!-- Kiểu dự án -->
                    <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="5" [nzXl]="4">
                        <nz-form-item class="mb-0">
                            <nz-form-label class="fs-12" style="font-size: 12px;">Kiểu dự án</nz-form-label>
                            <nz-form-control>
                                <nz-select name="projectTypeIds" class="w-100" [nzMaxTagCount]="2" nzAllowClear
                                    [nzMaxTagPlaceholder]="tagPlaceHolder" nzMode="multiple"
                                    nzPlaceHolder="Chọn kiểu dự án" nzSize="small" [(ngModel)]="projectTypeIds">
                                    @for (item of projectTypes; track $index) {
                                    <nz-option [nzLabel]="item.ProjectTypeCode + ' - ' + item.ProjectTypeName" [nzValue]="item.ID"></nz-option>
                                    }
                                </nz-select>
                                <ng-template #tagPlaceHolder let-selectedList>...</ng-template>
                            </nz-form-control>
                        </nz-form-item>
                    </nz-col>

                    <!-- Trạng thái -->
                    <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="5" [nzXl]="4" *ngIf="isHide">
                        <nz-form-item class="mb-0">
                            <nz-form-label class="fs-12" style="font-size: 12px;">Trạng thái</nz-form-label>
                            <nz-form-control>
                                <nz-select name="projecStatusIds" class="w-100" [nzMaxTagCount]="1" nzAllowClear
                                    [nzMaxTagPlaceholder]="tagPlaceHolder" nzMode="multiple"
                                    nzPlaceHolder="Chọn trạng thái" nzSize="small" [(ngModel)]="projecStatusIds">
                                    @for (item of projecStatuses; track $index) {
                                    <nz-option [nzLabel]="item.StatusName" [nzValue]="item.ID"></nz-option>
                                    }
                                </nz-select>
                                <ng-template #tagPlaceHolder let-selectedList>...</ng-template>
                            </nz-form-control>
                        </nz-form-item>
                    </nz-col>

                    <!-- Nút Đặt lại và Tìm kiếm -->
                    <nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="6" [nzXl]="6">
                        <nz-form-item class="mb-0">
                            <nz-form-label class="fs-12" style="font-size: 12px;" [style.visibility]="'hidden'">.</nz-form-label>
                            <nz-form-control>
                                <div class="d-flex gap-1">
                                    <button nz-button nzType="default" nzSize="small" (click)="setDefautSearch()">
                                        Đặt lại
                                    </button>
                                    <button nz-button nzType="primary" nzSize="small" (click)="searchProjects()">
                                        Tìm kiếm
                                    </button>
                                </div>
                            </nz-form-control>
                        </nz-form-item>
                    </nz-col>
                </nz-row>
            </form>
        </div>

        <!-- Content với bảng -->
        <div class="card-body p-0" [class.with-search-bar]="shouldShowSearchBar" [class.without-search-bar]="!shouldShowSearchBar">
            <nz-splitter>
                <nz-splitter-panel nzSize="" [nzCollapsible]="true" nzResizable="true">
                    <div #tb_projects style=" padding-right: 10px !important;"></div>
                </nz-splitter-panel>
                <nz-splitter-panel [nzSize]="sizeTbDetail" [nzCollapsible]="true" nzResizable="true">
                    <ng-template #tabClose>
                        <button nz-button nzType="text" class="btn-close-panel" style="color: red;"
                            (click)="closePanel()">
                            <i nz-icon nzType="close"></i>
                        </button>
                    </ng-template>
                    <nz-tabset style=" padding-left: 10px !important;" [nzTabBarExtraContent]="tabClose">
                        <nz-tab nzTitle="Danh sách hạng mục">
                            <div class="d-flex align-items-center p-1 gap-1 justify-content-sm-end">
                                <button class="fs-12 border" nz-button nzType="text" nzSize="small"
                                    style="background-color: lightyellow">
                                    Sắp hết hạn
                                </button>
                                <button class="fs-12 text-white" nz-button nzType="text" nzSize="small"
                                    style="background-color: orange">
                                    Chậm
                                </button>
                                <button class="fs-12 text-white" nz-button nzType="text" nzSize="small"
                                    style="background-color: red">
                                    Failed
                                </button>
                            </div>
                            <div class="border" #tb_projectWorkReport></div>
                        </nz-tab>
                        <nz-tab nzTitle="Kiểu dự án">
                            <div class="border" #tb_projectTypeLink></div>
                        </nz-tab>
                    </nz-tabset>

                </nz-splitter-panel>
            </nz-splitter>
        </div>
    </div>
</ng-container>

<!-- Template cho modal chọn ngày thay đổi trạng thái -->
<ng-template #statusDateModalContent>
  <div style="padding: 20px;">
    <div class="mb-3">
      <label class="d-block mb-2">
        <span class="text-danger">*</span> Ngày thay đổi trạng thái:
      </label>
      <nz-date-picker
        [(ngModel)]="selectedStatusDate"
        nzFormat="dd/MM/yyyy"
        nzPlaceHolder="Chọn ngày thay đổi trạng thái"
        style="width: 100%;"
      ></nz-date-picker>
    </div>
  </div>
</ng-template>