<div class="modal-dialog-scrollable">
    <div class="modal-header bg-primary align-items-center ps-3">
        <h6 class="text-light text-uppercase m-0 fw-bold">Chi tiết yêu cầu mua / mượn sản phẩm RTC</h6>
        <button type="button" class="btn-close position-absolute end-0 m-3" aria-label="Close"
            (click)="activeModal.dismiss()"></button>
    </div>

    <div class="modal-body">
        <form nz-form [formGroup]="validateForm" class="container-fluid" nzLayout="vertical">
            <!-- Row 1: Cột 1 - Khách hàng, Cột 2 - Trạng thái, Cột 3 - Loại phiếu -->
            <div nz-row [nzGutter]="16">
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label>Khách hàng</nz-form-label>
                        <nz-form-control>
                            <nz-select formControlName="CustomerID" nzPlaceHolder="Chọn khách hàng" name="CustomerID"
                                nzShowSearch="true" [nzDisabled]="true">
                                <nz-option *ngFor="let item of customers" [nzValue]="item.ID"
                                    [nzLabel]="item.CustomerCode + '-' + item.CustomerName">
                                </nz-option>
                            </nz-select>
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label>Trạng thái</nz-form-label>
                        <nz-form-control>
                            <input nz-input name="StatusRequest" formControlName="StatusRequest"
                                placeholder="Yêu cầu mua hàng" [disabled]="true" />
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label>Loại phiếu <span class="text-danger">(*)</span></nz-form-label>
                        <nz-form-control>
                            <nz-select formControlName="TicketType" 
                                       nzPlaceHolder="Chọn loại phiếu"
                                       name="TicketType">
                                <nz-option [nzValue]="0" nzLabel="Phiếu mua"></nz-option>
                                <nz-option [nzValue]="1" nzLabel="Phiếu mượn"></nz-option>
                            </nz-select>
                        </nz-form-control>
                    </nz-form-item>
                </div>
            </div>

            <!-- Row 2: Cột 1 - Mã nội bộ, Cột 2 - Tên sản phẩm, Cột 3 - Mã sản phẩm -->
            <div nz-row [nzGutter]="16">
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label class="fs-12 d-flex align-items-center">
                            <div class="d-flex"> Mã nội bộ
                                <button class="p-0 m-0 fs-12 px-1 h-auto" nz-button nzSize="small" 
                                    title="Thêm sản phẩm RTC"
                                    nzType="text" (click)="onAddProductRTC()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </nz-form-label>
                        <nz-form-control>
                            <nz-select formControlName="ProductRTCID" 
                                       nzPlaceHolder="Chọn sản phẩm "
                                       nzShowSearch="true" 
                                       nzAllowClear="true"
                                       name="ProductRTCID"
                                       (ngModelChange)="onProductRTCChange($event)">
                                <nz-option *ngFor="let item of productsRTC" 
                                           [nzValue]="item.ID"
                                           [nzLabel]="item.ProductCodeRTC || ''"
                                           nzCustomContent>
                                    <span>{{ (item.ProductCodeRTC || '') + ' - ' + (item.ProductName || '') }}</span>
                                </nz-option>
                            </nz-select>
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label>Tên sản phẩm <span class="text-danger">(*)</span></nz-form-label>
                        <nz-form-control nzErrorTip="Vui lòng nhập tên sản phẩm!">
                            <input nz-input name="ProductName" formControlName="ProductName"
                                placeholder="Nhập tên sản phẩm" />
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label nzRequired>Mã sản phẩm <span class="text-danger">(*)</span></nz-form-label>
                        <nz-form-control nzErrorTip="Vui lòng nhập mã sản phẩm!">
                            <input nz-input name="ProductCode" formControlName="ProductCode"
                                placeholder="Nhập mã sản phẩm" />
                        </nz-form-control>
                    </nz-form-item>
                </div>
            </div>

            <!-- Row 3: Cột 1 - Hãng, Cột 2 - Đơn vị, Cột 3 - Loại kho -->
            <div nz-row [nzGutter]="16">
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label nzRequired>Hãng</nz-form-label>
                        <nz-form-control nzErrorTip="Vui lòng chọn hãng">
                            <nz-select formControlName="FirmID" 
                                       nzPlaceHolder="Chọn hãng"
                                       nzShowSearch="true"
                                       name="FirmID">
                                <nz-option *ngFor="let item of firms" 
                                           [nzValue]="item.ID"
                                           [nzLabel]="item.FirmName"
                                           nzCustomContent>
                                    <span>{{ (item.FirmCode || '') + ' - ' + (item.FirmName || '') }}</span>
                                </nz-option>
                            </nz-select>
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label nzRequired>Đơn vị</nz-form-label>
                        <nz-form-control nzErrorTip="Vui lòng chọn đơn vị">
                            <nz-select formControlName="UnitCountID" 
                                       nzPlaceHolder="Chọn đơn vị"
                                       nzShowSearch="true"
                                       name="UnitCountID">
                                <nz-option *ngFor="let item of unitCounts" 
                                           [nzValue]="item.ID"
                                           [nzLabel]="item.UnitCountName || item.UnitName"
                                           nzCustomContent>
                                    <span>{{ (item.UnitCode || '') + ' - ' + (item.UnitCountName || item.UnitName || '') }}</span>
                                </nz-option>
                            </nz-select>
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label nzRequired>Loại kho <span class="text-danger">(*)</span></nz-form-label>
                        <nz-form-control nzErrorTip="Vui lòng chọn loại kho">
                            <nz-select class="w-100" 
                                       nzPlaceHolder="Chọn loại kho" 
                                       name="ProductGroupRTCID"
                                       formControlName="ProductGroupRTCID">
                                <nz-option *ngFor="let item of productGroupsRTC" 
                                           [nzValue]="item.ID"
                                           [nzLabel]="item.ProductGroupName"
                                           nzCustomContent>
                                    <span>{{ (item.ProductGroupNo || '') + ' - ' + (item.ProductGroupName || '') }}</span>
                                </nz-option>
                            </nz-select>
                        </nz-form-control>
                    </nz-form-item>
                </div>
            </div>

            <!-- Row 4: Cột 1 - Người yêu cầu, Cột 2 - Nhân viên mua, Cột 3 - Ngày yêu cầu -->
            <div nz-row [nzGutter]="16">
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <label class="form-label mb-2">Người yêu cầu</label>
                        <nz-select name="EmployeeRequestID" formControlName="EmployeeRequestID" class="w-100"
                            nzShowSearch nzPlaceHolder="Chọn người yêu cầu">
                            <ng-container *ngFor="let group of employeeRequests">
                                <nz-option-group [nzLabel]="group.label">
                                    <nz-option *ngFor="let option of group.options"
                                        [nzLabel]="option.item.Code +' - '+ option.item.FullName"
                                        [nzValue]="option.item.EmployeeID">
                                    </nz-option>
                                </nz-option-group>
                            </ng-container>
                        </nz-select>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <label class="form-label mb-2">Nhân viên mua <span class="text-danger">(*)</span></label>
                        <nz-form-control nzErrorTip="Vui lòng chọn nhân viên mua!">
                            <nz-select name="EmployeeBuyID" formControlName="EmployeeBuyID" class="w-100" nzShowSearch
                                nzPlaceHolder="Chọn nhân viên mua">
                                <ng-container *ngFor="let group of employeeBuys">
                                    <nz-option-group [nzLabel]="group.label">
                                        <nz-option *ngFor="let option of group.options"
                                            [nzLabel]="option.item.Code +' - '+ option.item.FullName"
                                            [nzValue]="option.item.EmployeeID">
                                        </nz-option>
                                    </nz-option-group>
                                </ng-container>
                            </nz-select>
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label>Ngày yêu cầu</nz-form-label>
                        <nz-form-control>
                            <nz-date-picker class="w-100" nzFormat="dd/MM/yyyy" name="DateRequest"
                                formControlName="DateRequest"></nz-date-picker>
                        </nz-form-control>
                    </nz-form-item>
                </div>
            </div>

            <!-- Row 5: Cột 1 - Deadline, Cột 2 - Ngày trả dự kiến (chỉ khi TicketType = 1), Cột 3 - Người duyệt (chỉ khi TicketType = 1) -->
            <div nz-row [nzGutter]="16">
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label>Deadline <span class="text-danger">(*)</span></nz-form-label>
                        <nz-form-control nzErrorTip="Vui lòng chọn deadline!">
                            <nz-date-picker class="w-100" nzFormat="dd/MM/yyyy" name="DateReturnExpected"
                                formControlName="DateReturnExpected"></nz-date-picker>
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="8" *ngIf="validateForm.get('TicketType')?.value === 1">
                    <nz-form-item>
                        <nz-form-label>Ngày trả dự kiến</nz-form-label>
                        <nz-form-control>
                            <nz-date-picker class="w-100" nzFormat="dd/MM/yyyy" name="DateReturnEstimated"
                                formControlName="DateReturnEstimated"></nz-date-picker>
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="8" *ngIf="validateForm.get('TicketType')?.value === 1">
                    <nz-form-item>
                        <nz-form-label nzRequired>Người duyệt <span class="text-danger">(*)</span></nz-form-label>
                        <nz-form-control nzErrorTip="Vui lòng chọn người duyệt!">
                            <nz-select name="EmployeeApproveID" formControlName="EmployeeApproveID" class="w-100" 
                                nzShowSearch nzPlaceHolder="Chọn người duyệt">
                                <nz-option *ngFor="let item of employeeApproves" 
                                           [nzValue]="item.EmployeeID || item.ID"
                                           [nzLabel]="(item.Code || '') + ' - ' + (item.FullName || item.EmployeeName || '')">
                                </nz-option>
                            </nz-select>
                        </nz-form-control>
                    </nz-form-item>
                </div>
            </div>

            <!-- Row 6: Cột 1 - Đơn giá, Cột 2 - Loại tiền, Cột 3 - Số lượng -->
            <div nz-row [nzGutter]="16">
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label>Đơn giá</nz-form-label>
                        <nz-form-control>
                            <nz-input-number nzMin="0" name="UnitPrice" formControlName="UnitPrice"
                                [nzFormatter]="formatAmount" [nzParser]="parseAmount"
                                class="form-control form-control-sm fs-12 w-100">
                            </nz-input-number>
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <label class="form-label mb-2">Loại tiền</label>
                        <nz-form-control>
                            <nz-select class="w-100" nzPlaceHolder="Chọn loại tiền" name="CurrencyID"
                                (ngModelChange)="onCurrencyChange($event)" formControlName="CurrencyID">
                                <nz-option *ngFor="let item of currencys" [nzValue]="item.ID"
                                    [nzLabel]="item.Code"></nz-option>
                            </nz-select>
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label>Số lượng <span class="text-danger">(*)</span></nz-form-label>
                        <nz-form-control nzErrorTip="Vui lòng nhập số lượng!">
                            <nz-input-number nzMin="0" name="Quantity" formControlName="Quantity"
                                class="form-control form-control-sm fs-12 w-100">
                            </nz-input-number>
                        </nz-form-control>
                    </nz-form-item>
                </div>
            </div>

            <!-- Row 7: Cột 1 - Tỷ giá, Cột 2 - % VAT, Cột 3 - Giá lịch sử -->
            <div nz-row [nzGutter]="16">
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label>Tỷ giá</nz-form-label>
                        <nz-form-control>
                            <nz-input-number nzMin="0" name="CurrencyRate" formControlName="CurrencyRate"
                                [nzFormatter]="formatAmount" [nzParser]="parseAmount"
                                class="form-control form-control-sm fs-12 w-100">
                            </nz-input-number>
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label>% VAT</nz-form-label>
                        <nz-form-control>
                            <nz-input-number nzMin="0" nzMax="100" nzStep="1" name="VAT" formControlName="VAT"
                                class="form-control form-control-sm fs-12 w-100">
                            </nz-input-number>
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label>Giá lịch sử</nz-form-label>
                        <nz-form-control>
                            <nz-input-number nzMin="0" name="HistoryPrice" formControlName="HistoryPrice"
                                [nzFormatter]="formatAmount" [nzParser]="parseAmount"
                                class="form-control form-control-sm fs-12 w-100">
                            </nz-input-number>
                        </nz-form-control>
                    </nz-form-item>
                </div>
            </div>

            <!-- Row 8: Cột 1 - Thành tiền chưa VAT, Cột 2 - Thành tiền quy đổi (VNĐ), Cột 3 - Thành tiền có VAT -->
            <div nz-row [nzGutter]="16">
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label>Thành tiền chưa VAT</nz-form-label>
                        <nz-form-control>
                            <nz-input-number nzMin="0" name="TotalPrice" formControlName="TotalPrice"
                                [nzFormatter]="formatAmount" [nzParser]="parseAmount"
                                class="form-control form-control-sm fs-12 w-100">
                            </nz-input-number>
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label>Thành tiền quy đổi (VNĐ)</nz-form-label>
                        <nz-form-control>
                            <nz-input-number nzMin="0" name="TotalPriceExchange" formControlName="TotalPriceExchange"
                                [nzFormatter]="formatAmount" [nzParser]="parseAmount"
                                class="form-control form-control-sm fs-12 w-100">
                            </nz-input-number>
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label>Thành tiền có VAT</nz-form-label>
                        <nz-form-control>
                            <nz-input-number nzMin="0" name="TotalMoneyVAT" formControlName="TotalMoneyVAT"
                                [nzFormatter]="formatAmount" [nzParser]="parseAmount"
                                class="form-control form-control-sm fs-12 w-100">
                            </nz-input-number>
                        </nz-form-control>
                    </nz-form-item>
                </div>
            </div>

            <!-- Row 9: Cột 1 - Nhà cung cấp -->
            <div nz-row [nzGutter]="16">
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label>Nhà cung cấp</nz-form-label>
                        <nz-form-control nzErrorTip="Vui lòng chọn NCC!">
                            <nz-select name="SupplierSaleID" formControlName="SupplierSaleID" nzPlaceHolder="Chọn NCC" nzShowSearch="true" nzAllowClear="true">
                                <nz-option *ngFor="let item of supplierSales" [nzValue]="item.ID"
                                    [nzLabel]="item.CodeNCC+' - '+ item.NameNCC">
                                </nz-option>
                            </nz-select>
                        </nz-form-control>
                    </nz-form-item>
                </div>
            </div>

            <!-- Row 10: Cột 1 - Đơn giá xuất xưởng, Cột 2 - Giá nhập khẩu, Cột 3 - Tổng tiền nhập khẩu -->
            <div nz-row [nzGutter]="16">
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label>Đơn giá xuất xưởng</nz-form-label>
                        <nz-form-control>
                            <nz-input-number nzMin="0" name="UnitFactoryExportPrice" [nzFormatter]="formatAmount"
                                [nzParser]="parseAmount" formControlName="UnitFactoryExportPrice"
                                class="form-control form-control-sm fs-12 w-100">
                            </nz-input-number>
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label>Giá nhập khẩu</nz-form-label>
                        <nz-form-control>
                            <nz-input-number nzMin="0" name="UnitImportPrice" formControlName="UnitImportPrice"
                                [nzFormatter]="formatAmount" [nzParser]="parseAmount"
                                class="form-control form-control-sm fs-12 w-100" />
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label>Tổng tiền nhập khẩu</nz-form-label>
                        <nz-form-control>
                            <nz-input-number nzMin="0" name="TotalImportPrice" formControlName="TotalImportPrice"
                                [nzFormatter]="formatAmount" [nzParser]="parseAmount"
                                class="form-control form-control-sm fs-12 w-100">
                            </nz-input-number>
                        </nz-form-control>
                    </nz-form-item>
                </div>
            </div>

            <!-- Row 11: Cột 1 - Lead Time, Cột 2 - Hàng nhập khẩu -->
            <div nz-row [nzGutter]="16">
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label>Lead Time</nz-form-label>
                        <nz-form-control>
                            <nz-input-number nzMin="0" nzMax="10000000000" nzStep="1" formControlName="LeadTime"
                                class="form-control form-control-sm fs-12 w-100">
                            </nz-input-number>
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <div nz-col [nzSpan]="8">
                    <nz-form-item>
                        <nz-form-label>&nbsp;</nz-form-label>
                        <nz-form-control>
                            <label nz-checkbox formControlName="IsImport">
                                Hàng nhập khẩu
                            </label>
                        </nz-form-control>
                    </nz-form-item>
                </div>
            </div>

            <!-- Row 8: Ghi chú -->
            <div nz-row [nzGutter]="16">
                <div nz-col [nzSpan]="24">
                    <nz-form-item *ngIf="!IsTechBought">
                        <nz-form-label>Ghi chú</nz-form-label>
                        <nz-form-control>
                            <input nz-input formControlName="Note" class="form-control form-control-sm w-100" />
                        </nz-form-control>
                    </nz-form-item>

                    <nz-form-item *ngIf="IsTechBought">
                        <nz-form-label>Ghi chú</nz-form-label>
                        <nz-form-control>
                            <nz-select (ngModelChange)="onStatusChange($event)" nzAllowClear="true">
                                <nz-option nzValue="0" nzLabel="Chưa làm gì"></nz-option>
                                <nz-option nzValue="1" nzLabel="Đã về"></nz-option>
                                <nz-option nzValue="2" nzLabel="Chưa về"></nz-option>
                            </nz-select>
                        </nz-form-control>
                    </nz-form-item>
                </div>
            </div>
        </form>
    </div>

    <div class="modal-footer py-1">
        <button nz-button nzType="default" nzDanger (click)="activeModal.dismiss()" [disabled]="isSaving">Đóng</button>
        <button nz-button nzType="primary" (click)="onSave()" [nzLoading]="isSaving" [disabled]="isSaving">
            <i class="fas fa-save me-1" *ngIf="!isSaving"></i> Lưu
        </button>
    </div>
</div>
