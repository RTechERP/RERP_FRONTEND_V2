<ng-container>
    <div *ngIf="showHeader" class="modal-header p-1 fs-12" style="background-color: #3469f7; border-radius: 0;">
        <h4 class="modal-title text-white uppercase">{{ headerText }}</h4>
        <button *ngIf="showCloseButton" type="button" class="btn-close me-2" aria-label="Close" (click)="closeModal()">
        </button>
    </div>

    <div class="card border-0 rounded-0 h-100">
        <div class="card-header bg-white p-1" style="overflow-x: auto;">
            <div class="d-flex gap-1" *ngIf="!isYCMH">
                <!-- Khi isApprovedBGD = true, chỉ hiển thị 2 nút BGD -->
                <ng-container *ngIf="isApprovedBGD && !isApprovedTBP">
                    <button nz-button nzType="default" nzSize="small"
                        (click)="onApproved(activeTabIndex, true, false)" *hasPermission="'N58,N1'">
                        <img class="btn-action-icon" src="assets/icon/action_check_24.svg" />BGD duyệt
                    </button>
                    <button nz-button nzType="default" nzSize="small"
                        (click)="onApproved(activeTabIndex, false, false)" *hasPermission="'N58,N1'">
                        <img class="btn-action-icon" src="assets/icon/action_cancle_24.svg" />BGD hủy duyệt
                    </button>
                </ng-container>

                <!-- Khi isApprovedTBP = true, chỉ hiển thị 2 nút TBP -->
                <ng-container *ngIf="isApprovedTBP && !isApprovedBGD">
                    <button nz-button nzType="default" nzSize="small"
                        (click)="onApproved(activeTabIndex, true, true)" *hasPermission="'N58,N1'">
                        <img class="btn-action-icon" src="assets/icon/action_check_24.svg" />TBP duyệt
                    </button>
                    <button nz-button nzType="default" nzSize="small"
                        (click)="onApproved(activeTabIndex, false, true)" *hasPermission="'N58,N1'">
                        <img class="btn-action-icon" src="assets/icon/action_cancle_24.svg" />TBP hủy duyệt
                    </button>
                </ng-container>

                <!-- Khi cả isApprovedTBP và isApprovedBGD đều false, hiển thị tất cả các nút -->
                <ng-container *ngIf="!isApprovedTBP && !isApprovedBGD">
                    <button nz-button nzType="default" nzSize="small"
                            (click)="ToggleSearchPanelNew($event); $event.stopPropagation()"
                            (mousedown)="$event.stopPropagation()"
                            (touchstart)="$event.stopPropagation()"
                            (touchend)="$event.stopPropagation()"
                            class="sticky-toggle-btn"
                            [attr.aria-label]="showSearchBar ? 'Ẩn tìm kiếm' : 'Hiện tìm kiếm'"
                            [attr.aria-expanded]="showSearchBar"
                            type="button">
                        <nz-icon [nzType]="showSearchBar ? 'up' : 'down'" />
                    </button>

                    <button nz-button nzType="default" nzSize="small" (click)="onCheckOrder(activeTabIndex, true)">
                        <img class="btn-action-icon" src="assets/icon/action_check_24.svg" />Check đặt hàng
                    </button>
                    <button nz-button nzType="default" nzSize="small" (click)="onCheckOrder(activeTabIndex, false)">
                        <img class="btn-action-icon" src="assets/icon/action_cancle_24.svg" />Hủy Check đặt hàng
                    </button>
                    <button nz-button nzType="default" nzSize="small" (click)="onSaveData(activeTabIndex)"
                        *hasPermission="'N35,N1'" [hidden]="isSelectedPO">
                        <img class="btn-action-icon" src="assets/icon/action_save_24.svg" />Lưu thay đổi
                    </button>
                    <button class="fs-12" nz-button nzType="default" nzSize="small" (click)="onEdit(activeTabIndex)"
                        *hasPermission="'N35,N1'">
                        <img class="btn-action-icon" src="assets/icon/action_edit_24.svg" />Sửa
                    </button>
                    <button class="fs-12" nz-button nzType="default" (click)="onDeleteRequest(activeTabIndex)"
                        *hasPermission="'N35,N1'" nzSize="small">
                        <img class="btn-action-icon" src="assets/icon/action_delete_24.svg" />Hủy Y/c
                    </button>
                    <button nz-button nzType="default" nzSize="small" *hasPermission="'N35,N1'"
                        (click)="onAddSupplierSale()">
                        <img class="btn-action-icon" src="assets/icon/action_add_24.svg" />Thêm NCC
                    </button>
                    <button nz-button nzType="default" nzSize="small"
                        (click)="onRequestApproved(activeTabIndex, true)" *hasPermission="'N35,N1'">
                        <img class="btn-action-icon" src="assets/icon/action_check_24.svg" />Y/C duyệt mua
                    </button>
                    <button nz-button nzType="default" nzSize="small"
                        (click)="onRequestApproved(activeTabIndex, false)" *hasPermission="'N35,N1'">
                        <img class="btn-action-icon" src="assets/icon/action_cancle_24.svg" />Hủy Y/C duyệt mua
                    </button>
                    <button nz-button nzType="default" nzSize="small" (click)="onCompleteRequest(activeTabIndex, 7)"
                        *hasPermission="'N35,N1'">
                        <img class="btn-action-icon" src="assets/icon/action_check_24.svg" />Hoàn thành
                    </button>
                    <button nz-button nzType="default" nzSize="small" (click)="onCompleteRequest(activeTabIndex, 1)"
                        *hasPermission="'N35,N1'">
                        <img class="btn-action-icon" src="assets/icon/action_cancle_24.svg" />Hủy hoàn thành
                    </button>
                    <button nz-button nzType="default" nzSize="small"
                        (click)="onApproved(activeTabIndex, true, false)" *hasPermission="'N58,N1'"
                        [hidden]="isSelectedPO">
                        <img class="btn-action-icon" src="assets/icon/action_check_24.svg" />BGD duyệt
                    </button>
                    <button nz-button nzType="default" nzSize="small"
                        (click)="onApproved(activeTabIndex, false, false)" *hasPermission="'N58,N1'"
                        [hidden]="isSelectedPO">
                        <img class="btn-action-icon" src="assets/icon/action_cancle_24.svg" />BGD hủy duyệt
                    </button>
                    <button nz-button nzType="default" nzSize="small" (click)="onAddPoncc()"
                        *hasPermission="'N35,N1'">
                        <img class="btn-action-icon" src="assets/icon/action_add_24.svg" />Tạo PO NCC
                    </button>
                    <button nz-button nzType="default" nzSize="small" (click)="onDownloadFile(activeTabIndex)"
                        *hasPermission="'N35,N1'">
                        <img class="btn-action-icon" src="assets/icon/action_dowload_file_24.svg" />Tải file
                    </button>
                    <button nz-button nzType="default" nzSize="small"
                        nz-dropdown
                        [nzDropdownMenu]="exportMenu"
                        nzTrigger="click"
                        nzPlacement="bottomLeft">
                        <img class="btn-action-icon" src="assets/icon/action_export_excel_24.svg" />Xuất Excel
                        <i nz-icon nzType="down"></i>
                    </button>
                    <nz-dropdown-menu #exportMenu="nzDropdownMenu">
                        <ul nz-menu>
                            <li nz-menu-item (click)="exportExcelSelectedRows()">
                                <img class="btn-action-icon" src="assets/icon/action_export_excel_24.svg" alt="Export Excel" />Xuất theo dòng đã chọn
                            </li>
                            <li nz-menu-item (click)="exportExcelAllTabs()">
                                <img class="btn-action-icon" src="assets/icon/action_export_excel_24.svg" alt="Export Excel" />Xuất tất cả
                            </li>
                        </ul>
                    </nz-dropdown-menu>
                </ng-container>
            </div>
            <div class="d-flex gap-1" *ngIf="isYCMH">
                <button nz-button nzType="default" nzSize="small" (click)="ToggleSearchPanelNew($event)"
                    style="min-width: 1.2vw;" aria-label="Tìm kiếm">
                    <nz-icon nzType="search" />
                </button>
                <button nz-button nzType="default" nzSize="small" (click)="onSelectYCMH()">
                    <img class="btn-action-icon" src="assets/icon/action_add_24.svg" />Chọn YCMH
                </button>
            </div>
        </div>

        <!-- Backdrop overlay cho mobile -->
        <div class="filter-backdrop"
             *ngIf="shouldShowSearchBar"
             (click)="ToggleSearchPanelNew()"
             [class.mobile-only]="true">
        </div>

        <!-- Filter bar - hiển thị dạng hàng ngang trên desktop, modal trên mobile -->
        <div class="filter-bar bg-light border-bottom p-2"
             *ngIf="shouldShowSearchBar"
             [class.mobile-modal]="true">
            <form nz-form nzLayout="inline" class="d-flex flex-wrap gap-2 align-items-end">
                <!-- Các filter mặc định hiển thị -->
                <nz-form-item class="mb-0">
                    <nz-form-label class="fs-12" style="font-size: 12px;">Từ ngày</nz-form-label>
                    <nz-form-control>
                        <nz-date-picker [(ngModel)]="dateStart" name="dateStart" nzFormat="dd/MM/yyyy"
                            style="width: 150px; font-size: 12px;" nzSize="small" nzAllowClear="false"></nz-date-picker>
                    </nz-form-control>
                </nz-form-item>

                <nz-form-item class="mb-0">
                    <nz-form-label class="fs-12" style="font-size: 12px;">Đến ngày</nz-form-label>
                    <nz-form-control>
                        <nz-date-picker [(ngModel)]="dateEnd" name="dateEnd" nzFormat="dd/MM/yyyy"
                            style="width: 150px; font-size: 12px;" nzSize="small" nzAllowClear="false"></nz-date-picker>
                    </nz-form-control>
                </nz-form-item>

                <nz-form-item class="mb-0">
                    <nz-form-label class="fs-12" style="font-size: 12px;">Trạng thái</nz-form-label>
                    <nz-form-control>
                        <nz-select style="width: 180px; font-size: 12px;" [(ngModel)]="statusRequestFilter" nzShowSearch nzAllowClear
                            nzSize="small" name="statusRequest" nzPlaceHolder="--Tất cả--">
                            <nz-option *ngFor="let s of statusOptions" [nzValue]="s.value"
                                [nzLabel]="s.label"></nz-option>
                        </nz-select>
                    </nz-form-control>
                </nz-form-item>

                <nz-form-item class="mb-0">
                    <nz-form-label class="fs-12" style="font-size: 12px;">Từ khóa</nz-form-label>
                    <nz-form-control>
                        <input nz-input placeholder="Mã SP, ghi chú..." nzSize="small" [(ngModel)]="keyword"
                            name="keyword" style="width: 150px; font-size: 12px;" (keyup.enter)="onSearch()" />
                    </nz-form-control>
                </nz-form-item>

                <!-- Nút tìm kiếm với dropdown cho filter bổ sung -->
                <nz-form-item class="mb-0">
                    <nz-form-control>
                        <div class="btn-group">
                            <button nz-button nzType="primary" nzSize="small" (click)="onSearch()">
                                Tìm kiếm
                            </button>
                            <button nz-button nzType="primary" nzSize="small"
                                    nz-dropdown
                                    [nzDropdownMenu]="searchMenu"
                                    nzTrigger="click"
                                    nzPlacement="bottomRight"
                                    style="padding-left: 8px; padding-right: 8px;">
                                <i nz-icon nzType="down"></i>
                            </button>
                            <nz-dropdown-menu #searchMenu="nzDropdownMenu">
                                <div class="p-3 advanced-filters-container" style="min-width: 300px; background-color: #ffffff; border: 1px solid #d9d9d9; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                    <ng-container *ngTemplateOutlet="advancedFiltersTemplate"></ng-container>
                                </div>
                            </nz-dropdown-menu>
                        </div>
                    </nz-form-control>
                </nz-form-item>
            </form>
        </div>

        <!-- Content với tabs -->
        <div class="card-body p-0" [class.with-search-bar]="shouldShowSearchBar" [class.without-search-bar]="!shouldShowSearchBar">
            <div *ngIf="isLoading">
                <nz-spin [nzSpinning]="isLoading" nzSimple [style]="{
                    position: 'absolute',
                    top: '0',
                    left: '0',
                    width: '100%',
                    height: '100%',
                    background: 'rgba(255,255,255,0.4)',
                    zIndex: '999',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                    }"></nz-spin>
            </div>
            <nz-tabset class="ms-2 h-100" (nzSelectedIndexChange)="onTabChange($event)">
                <nz-tab class="purchase-tab h-100" *ngFor="let tab of filteredTabs; let i = index" [nzTitle]="tab.title">
                    <div class="table-container mt-1 grid-container h-100" [class]="'grid-container-' + tab.id"
                        *ngIf="shouldRenderGrid(tab.id) && columnDefinitionsMap.has(tab.id)"
                        style="height: 100%; width: 100%;">
                        <angular-slickgrid
                            [gridId]="'grid-' + tab.id"
                            [columns]="columnDefinitionsMap.get(tab.id) || []"
                            [options]="gridOptionsMap.get(tab.id) || {}"
                            [dataset]="datasetsMap.get(tab.id) || []"
                            (onAngularGridCreated)="angularGridReady(tab.id, $event.detail)"
                            (onClick)="onCellClicked(tab.id, $event.detail.eventData, $event.detail.args)"
                            (onCellChange)="onCellChange(tab.id, $event.detail.eventData, $event.detail.args)"
                            (onSelectedRowsChanged)="handleRowSelection(tab.id, $event.detail.eventData, $event.detail.args)">
                        </angular-slickgrid>
                    </div>
                </nz-tab>
            </nz-tabset>
        </div>
    </div>
</ng-container>

<ng-template #advancedFiltersTemplate>
    <div style="background-color: #ffffff;padding: 0;">
        <form nz-form nzLayout="vertical" class="mt-1">
            <nz-form-item>
                <nz-form-label class="fs-12">Dự án</nz-form-label>
                <nz-form-control>
                    <nz-select style="width: 100%" [(ngModel)]="projectIdFilter" name="projectId" nzShowSearch
                        nzAllowClear nzSize="small" nzPlaceHolder="Chọn dự án">
                        <nz-option *ngFor="let p of projects" [nzValue]="p.ID"
                            [nzLabel]="p.ProjectCode + ' - ' + p.ProjectName"></nz-option>
                    </nz-select>
                </nz-form-control>
            </nz-form-item>

            <nz-form-item class="mt-1">
                <nz-form-label class="fs-12">Nhà cung cấp</nz-form-label>
                <nz-form-control>
                    <nz-select style="width: 100%" nzShowSearch nzAllowClear name="supplierId"
                        [(ngModel)]="supplierId" nzPlaceHolder="Chọn nhà cung cấp">
                        <nz-option *ngFor="let s of supplierSales" [nzValue]="s.ID"
                            [nzLabel]="s.NameNCC"></nz-option>
                    </nz-select>
                </nz-form-control>
            </nz-form-item>

            <nz-form-item class="mt-1">
                <nz-form-label class="fs-12">Tình trạng</nz-form-label>
                <nz-form-control>
                    <nz-select style="width: 100%" nzShowSearch nzAllowClear name="isDeletedFilter"
                        nzAllowClear="false" [(ngModel)]="isDeletedFilter" nzPlaceHolder="--Tất cả--">
                        <nz-option *ngFor="let a of deletedOptions" [nzValue]="a.value"
                            [nzLabel]="a.label"></nz-option>
                    </nz-select>
                </nz-form-control>
            </nz-form-item>

            <nz-form-item class="mt-1">
                <nz-form-label class="fs-12">Trạng thái BGĐ</nz-form-label>
                <nz-form-control>
                    <nz-select style="width: 100%" nzShowSearch nzAllowClear name="approvedBGD"
                        nzAllowClear="false" [(ngModel)]="isApprovedBGDFilter" nzPlaceHolder="--Tất cả--">
                        <nz-option *ngFor="let a of approvalOptions" [nzValue]="a.value"
                            [nzLabel]="a.label"></nz-option>
                    </nz-select>
                </nz-form-control>
            </nz-form-item>

            <nz-form-item class="mt-1">
                <nz-form-label class="fs-12">Số POKH</nz-form-label>
                <nz-form-control>
                    <nz-select style="width: 100%" nzShowSearch nzAllowClear name="pokhId"
                        [(ngModel)]="pokhIdFilter" nzPlaceHolder="Chọn Số PO KH">
                        <nz-option *ngFor="let po of lstPOKH" [nzValue]="po.ID"
                            [nzLabel]="po.POCode"></nz-option>
                    </nz-select>
                </nz-form-control>
            </nz-form-item>
        </form>
    </div>
</ng-template>
